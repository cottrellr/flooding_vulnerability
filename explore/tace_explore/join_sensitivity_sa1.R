## Sensitivity 

# Load libraries
library(sf)
library(tidyverse)
library(janitor)
library(here)
library(rmapshaper)
library(ozmaps)
library(skimr)
library(zoo)

# Get SA1 polygons

bris_sa1 <- st_read(here('data/spatial/SA1_2021_AUST_SHP_GDA2020/SA1_2021_AUST_GDA2020.shp')) %>% 
  filter(GCC_NAME21 == "Greater Brisbane")  %>% 
  select(SA1_CODE21, geometry)
bris_sa1$SA1_CODE21 <- as.numeric(bris_sa1$SA1_CODE21)
#st_write(bris_sa1, "data/spatial/SA1_Bris/bris_sa1.shp")

ggplot() +
  geom_sf(data = bris_sa1) +
  theme_bw() +
  theme(legend.position = "none")

########## DWELLINGS CODE ###########

# 
# Get census data and filter out Brisbane's SA1 data
dwell <- read_csv('data/raw_data/2021_census/SA1/G36 Dwelling structure.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
names(dwell)

# Get the counts of persons whose home is vulnerable to flooding
prop_house <- dwell %>%
  select(sa1_code_2021,
         op_ds_separate_house_persons,
         op_ds_sd_r_t_h_th_1_sty_psns,
         op_ds_sd_r_t_h_th_2_m_sty_psns,
         op_ds_f_ap_i_1or2_sty_blk_ps,
         op_ds_flt_apt_att_house_ps,
         op_ds_oth_dw_cvn_ps,
         op_ds_oth_dwg_cab_hboat_ps,
         op_ds_ot_dwg_im_hm_tnt_so_ps,
         op_ds_ot_dwg_hs_f_att_sh_of_ps,
         total_p_ds_persons)

# Calculate the proportion of persons whose home is vulnerable to flooding
prop_house <- mutate(prop_house,
                     prop_house = (op_ds_separate_house_persons +
                                     op_ds_sd_r_t_h_th_1_sty_psns +
                                     op_ds_sd_r_t_h_th_2_m_sty_psns +
                                     op_ds_f_ap_i_1or2_sty_blk_ps +
                                     op_ds_flt_apt_att_house_ps +
                                     op_ds_oth_dw_cvn_ps +
                                     op_ds_oth_dwg_cab_hboat_ps +
                                     op_ds_ot_dwg_im_hm_tnt_so_ps +
                                     op_ds_ot_dwg_hs_f_att_sh_of_ps) / total_p_ds_persons)

# Adjust cases where random data is greater than 100%
for (row in 1:nrow(prop_house)) {
  prop_house$prop_house[row] <- min(prop_house$prop_house[row], 1)
}

# Join with SA1 shapefile
prop_house %>%
  full_join(bris_sa1, by = c('sa1_code_2021' = 'SA1_CODE21'))

# Write to a csv
write.csv(prop_house, 'data/processed_data/SA1/dwell_house2021.csv', row.names = FALSE)

# Turn into a shapefile
prop_house_sf <- merge(bris_sa1, prop_house, by.x = "SA1_CODE21", by.y = "sa1_code_2021", all = TRUE)

# Plot
ggplot() +
  geom_sf(data = prop_house_sf, aes(fill = prop_house)) +
  theme_bw()

####################################

########## EDUCATION CODE ##########

edu <- read_csv('data/raw_data/2021_census/SA1/G16A Highest year of school completed by age by sex.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
edu2 <- read_csv('data/raw_data/2021_census/SA1/G16B Highest year of school completed by age by sex.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
edu <- cbind(edu, edu2[,3:ncol(edu2)])
names(edu)

prop_uned <- edu %>%
  select(sa1_code_2021,
         p_y9e_tot,
         p_y8b_tot,
         p_dngts_tot,
         p_tot_tot)

prop_uned <- mutate(prop_uned,
                   prop_uned = (p_y9e_tot +
                                  p_y8b_tot +
                                  p_dngts_tot) / p_tot_tot)

for (row in 1:nrow(prop_uned)) {
  prop_uned$prop_uned[row] <- min(prop_uned$prop_uned[row], 1)
}

skim(prop_uned)

# returns tibble
prop_uned %>%
  full_join(bris_sa1, by = c('sa1_code_2021' = 'SA1_CODE21'))

write.csv(prop_uned, 'data/processed_data/SA1/edu2021.csv', row.names = FALSE)

prop_uned_sf <- merge(bris_sa1, prop_uned, by.x = "SA1_CODE21", by.y = "sa1_code_2021", all = TRUE)

ggplot() +
  geom_sf(data = prop_uned_sf, aes(fill = prop_uned)) +
  theme_bw()

####################################

######### DISABILITY CODE ##########
disabl <- read_csv('data/raw_data/2021_census/SA1/G18 Core activity need for assistance by age by sex.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
names(disabl)

prop_disabl <- disabl %>%
  select(sa1_code_2021,
         p_tot_need_for_assistance,
         p_tot_tot)

prop_disabl <- mutate(prop_disabl,
                   prop_disabl = p_tot_need_for_assistance / p_tot_tot)

for (row in 1:nrow(prop_disabl)) {
  prop_disabl$prop_disabl[row] <- min(prop_disabl$prop_disabl[row], 1)
}

skim(prop_disabl)

# returns tibble
prop_disabl %>%
  full_join(bris_sa1, by = c('sa1_code_2021' = 'SA1_CODE21'))

write.csv(prop_disabl, 'data/processed_data/SA1/disabl2021.csv', row.names = FALSE)

prop_disabl_sf <- merge(bris_sa1, prop_disabl, by.x = "SA1_CODE21", by.y = "sa1_code_2021", all = TRUE)

ggplot() +
  geom_sf(data = prop_disabl_sf, aes(fill = prop_disabl)) +
  theme_bw()

####################################

####### VULNERABLE AGE CODE ########
vulnrblA <- read_csv('data/raw_data/2021_census/SA1/G04A Age by sex.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
vulnrblB <- read_csv('data/raw_data/2021_census/SA1/G04B Age by sex.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
vulnrbl <- cbind(vulnrblA, vulnrblB[3:ncol(vulnrblB)])
names(vulnrbl)

# - "0-4 years" for vulnerable young
# - "90-94 years", "95-99 years", "100 years and over" for vulnerable old
prop_vulnrbl <- vulnrbl %>%
  select(sa1_code_2021,
         age_yr_0_4_p,
         age_yr_90_94_p,
         age_yr_95_99_p,
         age_yr_100_yr_over_p,
         tot_p)

prop_vulnrbl <- mutate(prop_vulnrbl,
                   prop_young = age_yr_0_4_p / tot_p)
prop_vulnrbl <- mutate(prop_vulnrbl,
                       prop_old = (age_yr_90_94_p +
                                     age_yr_95_99_p +
                                     age_yr_100_yr_over_p) / tot_p)

for (row in 1:nrow(prop_vulnrbl)) {
  prop_vulnrbl$prop_young[row] <- min(prop_vulnrbl$prop_young[row], 1)
  prop_vulnrbl$prop_old[row] <- min(prop_vulnrbl$prop_old[row], 1)
}

skim(prop_vulnrbl)

# returns tibble
prop_vulnrbl %>%
  full_join(bris_sa1, by = c('sa1_code_2021' = 'SA1_CODE21'))

write.csv(prop_vulnrbl[, 1:(ncol(prop_vulnrbl)-1)], 'data/processed_data/SA1/vulnerable_young2021.csv', row.names = FALSE)
write.csv(subset(prop_vulnrbl, select = -c(prop_young)), 'data/processed_data/SA1/vulnerable_old2021.csv', row.names = FALSE)

prop_vulnrbl_sf <- merge(bris_sa1, prop_vulnrbl, by.x = "SA1_CODE21", by.y = "sa1_code_2021", all = TRUE)

ggplot() +
  geom_sf(data = prop_vulnrbl_sf, aes(fill = prop_young)) +
  theme_bw()

####################################

######## UNEMPLOYMENT CODE #########
unempA <- read_csv('data/raw_data/2021_census/SA1/G46A Labour force status by age by sex.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
unempB <- read_csv('data/raw_data/2021_census/SA1/G46B Labour force status by age by sex.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
unemp <- cbind(unempA, unempB[3:ncol(unempB)])
names(unemp)

prop_unemp <- unemp %>%
  select(sa1_code_2021,
         p_tot_unemp_tot,
         p_tot_tot)

prop_unemp <- mutate(prop_unemp,
                   prop_unemp = p_tot_unemp_tot / p_tot_tot)

for (row in 1:nrow(prop_unemp)) {
  prop_unemp$prop_unemp[row] <- min(prop_unemp$prop_unemp[row], 1)
}

skim(prop_unemp)

# returns tibble
prop_unemp %>%
  full_join(bris_sa1, by = c('sa1_code_2021' = 'SA1_CODE21'))

write.csv(prop_unemp, 'data/processed_data/SA1/unemployed2021.csv', row.names = FALSE)

prop_unemp_sf <- merge(bris_sa1, prop_unemp, by.x = "SA1_CODE21", by.y = "sa1_code_2021", all = TRUE)

ggplot() +
  geom_sf(data = prop_unemp_sf, aes(fill = prop_unemp)) +
  theme_bw()

####################################

############# ESL CODE #############
eslA <- read_csv('data/raw_data/2021_census/SA1/G13A Language used at home by proficiency in spoken English by sex.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
eslB <- read_csv('data/raw_data/2021_census/SA1/G13B Language used at home by proficiency in spoken English by sex.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
eslC <- read_csv('data/raw_data/2021_census/SA1/G13C Language used at home by proficiency in spoken English by sex.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
eslD <- read_csv('data/raw_data/2021_census/SA1/G13D Language used at home by proficiency in spoken English by sex.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
eslE <- read_csv('data/raw_data/2021_census/SA1/G13E Language used at home by proficiency in spoken English by sex.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
esl <- cbind(eslA, eslB[3:ncol(eslB)], eslC[3:ncol(eslC)], eslD[3:ncol(eslD)], eslE[3:ncol(eslE)])
names(esl)

# Select relevant columns only
prop_esl <- esl %>%
  select(sa1_code_2021,
         p_tot_uolse_tot,
         p_tot_tot)

# Calculate proportion
prop_esl <- mutate(prop_esl,
                   prop_esl = p_tot_uolse_tot / p_tot_tot)

# Deal with percentages over 100% caused by data randomness
for (row in 1:nrow(prop_esl)) {
  prop_esl$prop_esl[row] <- min(prop_esl$prop_esl[row], 1)
}

# Get summary
skim(prop_esl)

# returns tibble
prop_esl %>%
  full_join(bris_sa1, by = c('sa1_code_2021' = 'SA1_CODE21'))

# Write to csv
write.csv(prop_esl, 'data/processed_data/SA1/esl2021.csv', row.names = FALSE)

prop_esl_sf <- merge(bris_sa1, prop_esl, by.x = "SA1_CODE21", by.y = "sa1_code_2021", all = TRUE)

ggplot() +
  geom_sf(data = prop_esl_sf, aes(fill = prop_esl)) +
  theme_bw()

####################################

######### INDIGENOUS CODE ##########
indigenous <- read_csv('../../data/raw_data/2021_census/SA1/G01 Selected person characteristics by sex.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
names(indigenous)

# Select relevant columns only
prop_indigenous <- indigenous %>%
  select(sa1_code_2021,
         indigenous_psns_aboriginal_p,
         indig_psns_torres_strait_is_p,
         indig_bth_abor_torres_st_is_p,
         tot_p_p)

# Calculate proportion
prop_indigenous <- mutate(prop_indigenous,
                          prop_indigenous = (indigenous_psns_aboriginal_p +
                                               indig_psns_torres_strait_is_p +
                                               indig_bth_abor_torres_st_is_p) /
                            tot_p_p)

# Deal with percentages over 100% caused by data randomness
for (row in 1:nrow(prop_indigenous)) {
  prop_indigenous$prop_indigenous[row] <- min(prop_indigenous$prop_indigenous[row], 1)
}

# Get summary
skim(prop_indigenous)

# Write to csv
write.csv(prop_indigenous, '../../data/processed_data/SA1/indigenous2021.csv', row.names = FALSE)

prop_indigenous_sf <- merge(bris_sa1,
                            prop_indigenous,
                            by.x = "SA1_CODE21",
                            by.y = "sa1_code_2021",
                            all.x = TRUE,
                            all = TRUE)

ggplot() +
  geom_sf(data = prop_indigenous_sf, aes(fill = prop_indigenous)) +
  theme_bw()

####################################

####### LONGTERM HEALTH CODE #######
health_condA <- read_csv('data/raw_data/2021_census/SA1/G20A Count of selected long-term health conditions by age by sex.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
health_condB <- read_csv('data/raw_data/2021_census/SA1/G20B Count of selected long-term health conditions by age by sex.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
health_cond <- cbind(health_condA, health_condB[3:ncol(health_condB)])
names(health_cond)

# Select relevant columns only
prop_health_cond <- health_cond %>%
  select(sa1_code_2021,
         p_1_cond_tot,
         p_2_cond_tot,
         p_3_or_mo_cond_tot,
         p_tot_tot)

# Calculate proportion
prop_health_cond <- mutate(prop_health_cond,
                           prop_health_cond = (p_1_cond_tot +
                                                 p_2_cond_tot +
                                                 p_3_or_mo_cond_tot) /
                             p_tot_tot)

# Deal with percentages over 100% caused by data randomness
for (row in 1:nrow(prop_health_cond)) {
  prop_health_cond$prop_health_cond[row] <- min(prop_health_cond$prop_health_cond[row], 1)
}

# Get summary
skim(prop_health_cond)

# returns tibble
prop_health_cond %>%
  full_join(bris_sa1, by = c('sa1_code_2021' = 'SA1_CODE21'))

# Write to csv
write.csv(prop_health_cond, 'data/processed_data/SA1/long-term_health_cond2021.csv', row.names = FALSE)

prop_health_cond_sf <- merge(bris_sa1,
                             prop_health_cond,
                             by.x = "SA1_CODE21",
                             by.y = "sa1_code_2021",
                             all.x = TRUE,
                             all = TRUE)

ggplot() +
  geom_sf(data = prop_health_cond_sf, aes(fill = prop_health_cond)) +
  theme_bw()

####################################

######## POPULATION CODE ###########
pop2021 <- read_csv('data/raw_data/2021_census/SA1/G01 Selected person characteristics by sex.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
names(pop2021)

# Select relevant columns only
pop_2021 <- pop2021 %>%
  select(sa1_code_2021,
         tot_p_p)

# returns tibble
pop_2021 %>%
  full_join(bris_sa1, by = c('sa1_code_2021' = 'SA1_CODE21'))

# Write to csv
write.csv(pop_2021, 'data/processed_data/SA1/Population2021.csv', row.names = FALSE)

pop_2021_sf <- merge(bris_sa1,
                     pop_2021,
                     by.x = "SA1_CODE21",
                     by.y = "sa1_code_2021",
                     all = TRUE)

ggplot() +
  geom_sf(data = pop_2021_sf, aes(fill = tot_p_p)) +
  theme_bw()

####################################

####### FAMILY DWELLING CODE #######
familydwell <- read_csv('data/raw_data/2021_census/SA1/G42 Dwelling structure by household composition and family composition.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
names(familydwell)

# Select relevant columns only
prop_familydwell <- familydwell %>%
  select(sa1_code_2021,
         tot_f_hs_one_pf,
         tot_f_hs_oth_fam,
         tot_group_h,
         tot_tot)

# Calculate proportion
prop_familydwell <- mutate(prop_familydwell,
                           prop_familydwell = (tot_f_hs_one_pf +
                                                 tot_f_hs_oth_fam +
                                                 tot_group_h) /
                             tot_tot)

# Deal with percentages over 100% caused by data randomness
for (row in 1:nrow(prop_familydwell)) {
  prop_familydwell$prop_familydwell[row] <- min(prop_familydwell$prop_familydwell[row], 1)
}

# Get summary
skim(prop_familydwell)

# returns tibble
prop_familydwell %>%
  full_join(bris_sa1, by = c('sa1_code_2021' = 'SA1_CODE21'))

# Write to csv
write.csv(prop_familydwell, 'data/processed_data/SA1/familydwelling2021.csv', row.names = FALSE)

prop_familydwell_sf <- merge(bris_sa1,
                             prop_familydwell,
                             by.x = "SA1_CODE21",
                             by.y = "sa1_code_2021",
                             all = TRUE)

ggplot() +
  geom_sf(data = prop_familydwell_sf, aes(fill = prop_familydwell)) +
  theme_bw()
####################################
