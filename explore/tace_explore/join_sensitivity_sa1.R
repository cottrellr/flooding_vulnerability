## Sensitivity 

# Load libraries
library(sf)
library(tidyverse)
library(janitor)
library(here)
library(rmapshaper)
library(ozmaps)
library(skimr)
library(zoo)

# Get SA1 polygons

bris_sa1 <- st_read(here('data/spatial/SA1_2021_AUST_SHP_GDA2020/SA1_2021_AUST_GDA2020.shp')) %>% 
  filter(GCC_NAME21 == "Greater Brisbane")  %>% 
  select(SA1_CODE21, geometry)
bris_sa1$SA1_CODE21 <- as.numeric(bris_sa1$SA1_CODE21)
st_write(bris_sa1, "data/spatial/SA1_Bris/bris_sa1.shp")

ggplot() +
  geom_sf(data = bris_sa1) +
  theme_bw() +
  theme(legend.position = "none")

####################################

# DWELLINGS CODE
# Get census data and filter out Brisbane's SA1 data
dwell <- read_csv('data/raw_data/2021_census/SA1/G36 Dwelling structure.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
names(dwell)

# Get the counts of persons whose home is vulnerable to flooding
prop_house <- dwell %>%
  select(sa1_code_2021,
         op_ds_separate_house_persons,
         op_ds_sd_r_t_h_th_1_sty_psns,
         op_ds_sd_r_t_h_th_2_m_sty_psns,
         op_ds_f_ap_i_1or2_sty_blk_ps,
         op_ds_flt_apt_att_house_ps,
         op_ds_oth_dw_cvn_ps,
         op_ds_oth_dwg_cab_hboat_ps,
         op_ds_ot_dwg_im_hm_tnt_so_ps,
         op_ds_ot_dwg_hs_f_att_sh_of_ps,
         total_p_ds_persons)

# Calculate the proportion of persons whose home is vulnerable to flooding
prop_house <- mutate(prop_house,
                     prop_house = (op_ds_separate_house_persons +
                                     op_ds_sd_r_t_h_th_1_sty_psns +
                                     op_ds_sd_r_t_h_th_2_m_sty_psns +
                                     op_ds_f_ap_i_1or2_sty_blk_ps +
                                     op_ds_flt_apt_att_house_ps +
                                     op_ds_oth_dw_cvn_ps +
                                     op_ds_oth_dwg_cab_hboat_ps +
                                     op_ds_ot_dwg_im_hm_tnt_so_ps +
                                     op_ds_ot_dwg_hs_f_att_sh_of_ps) / total_p_ds_persons)

# Adjust cases where random data is greater than 100%
for (row in 1:nrow(prop_house)) {
  prop_house$prop_house[row] <- min(prop_house$prop_house[row], 1)
}

# Join with SA1 shapefile
prop_house %>%
  full_join(bris_sa1, by = c('sa1_code_2021' = 'SA1_CODE21'))

# Write to a csv
write.csv(prop_house, 'data/processed_data/SA1/dwell_house2021.csv', row.names = FALSE)

# Turn into a shapefile
prop_house_sf <- merge(bris_sa1, prop_house, by.x = "SA1_CODE21", by.y = "sa1_code_2021", all = TRUE)

# Plot
ggplot() +
  geom_sf(data = prop_house_sf, aes(fill = prop_house)) +
  theme_bw()

####################################

# EDUCATION CODE
edu <- read_csv('data/raw_data/2021_census/SA1/G16A Highest year of school completed by age by sex.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
edu2 <- read_csv('data/raw_data/2021_census/SA1/G16B Highest year of school completed by age by sex.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
edu <- cbind(edu, edu2[,3:ncol(edu2)])
names(edu)

prop_uned <- edu %>%
  select(sa1_code_2021,
         p_y9e_tot,
         p_y8b_tot,
         p_dngts_tot,
         p_tot_tot)

prop_uned <- mutate(prop_uned,
                   prop_uned = (p_y9e_tot +
                                  p_y8b_tot +
                                  p_dngts_tot) / p_tot_tot)

for (row in 1:nrow(prop_uned)) {
  prop_uned$prop_uned[row] <- min(prop_uned$prop_uned[row], 1)
}

skim(prop_uned)

# returns tibble
prop_uned %>%
  full_join(bris_sa1, by = c('sa1_code_2021' = 'SA1_CODE21'))

write.csv(prop_uned, 'data/processed_data/SA1/edu2021.csv', row.names = FALSE)

prop_uned_sf <- merge(bris_sa1, prop_uned, by.x = "SA1_CODE21", by.y = "sa1_code_2021", all = TRUE)

ggplot() +
  geom_sf(data = prop_uned_sf, aes(fill = prop_uned)) +
  theme_bw()

####################################

# DISABILITY CODE
disabl <- read_csv('data/raw_data/2021_census/SA1/G18 Core activity need for assistance by age by sex.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
names(disabl)

prop_disabl <- disabl %>%
  select(sa1_code_2021,
         p_tot_need_for_assistance,
         p_tot_tot)

prop_disabl <- mutate(prop_disabl,
                   prop_disabl = p_tot_need_for_assistance / p_tot_tot)

for (row in 1:nrow(prop_disabl)) {
  prop_disabl$prop_disabl[row] <- min(prop_disabl$prop_disabl[row], 1)
}

skim(prop_disabl)

# returns tibble
prop_disabl %>%
  full_join(bris_sa1, by = c('sa1_code_2021' = 'SA1_CODE21'))

write.csv(prop_disabl, 'data/processed_data/SA1/disabl2021.csv', row.names = FALSE)

prop_disabl_sf <- merge(bris_sa1, prop_disabl, by.x = "SA1_CODE21", by.y = "sa1_code_2021", all = TRUE)

ggplot() +
  geom_sf(data = prop_disabl_sf, aes(fill = prop_disabl)) +
  theme_bw()

####################################

# VULNERABLE AGE CODE
vulnrblA <- read_csv('data/raw_data/2021_census/SA1/G04A Age by sex.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
vulnrblB <- read_csv('data/raw_data/2021_census/SA1/G04B Age by sex.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
vulnrbl <- cbind(vulnrblA, vulnrblB[3:ncol(vulnrblB)])
names(vulnrbl)

# - "0-4 years" for vulnerable young
# - "90-94 years", "95-99 years", "100 years and over" for vulnerable old
prop_vulnrbl <- vulnrbl %>%
  select(sa1_code_2021,
         age_yr_0_4_p,
         age_yr_90_94_p,
         age_yr_95_99_p,
         age_yr_100_yr_over_p,
         tot_p)

prop_vulnrbl <- mutate(prop_vulnrbl,
                   prop_young = age_yr_0_4_p / tot_p)
prop_vulnrbl <- mutate(prop_vulnrbl,
                       prop_old = (age_yr_90_94_p +
                                     age_yr_95_99_p +
                                     age_yr_100_yr_over_p) / tot_p)

for (row in 1:nrow(prop_vulnrbl)) {
  prop_vulnrbl$prop_young[row] <- min(prop_vulnrbl$prop_young[row], 1)
  prop_vulnrbl$prop_old[row] <- min(prop_vulnrbl$prop_old[row], 1)
}

skim(prop_vulnrbl)

# returns tibble
prop_vulnrbl %>%
  full_join(bris_sa1, by = c('sa1_code_2021' = 'SA1_CODE21'))

write.csv(prop_vulnrbl[, 1:(ncol(prop_vulnrbl)-1)], 'data/processed_data/SA1/vulnerable_young2021.csv', row.names = FALSE)
write.csv(subset(prop_vulnrbl, select = -c(prop_young)), 'data/processed_data/SA1/vulnerable_old2021.csv', row.names = FALSE)

prop_vulnrbl_sf <- merge(bris_sa1, prop_vulnrbl, by.x = "SA1_CODE21", by.y = "sa1_code_2021", all = TRUE)

ggplot() +
  geom_sf(data = prop_vulnrbl_sf, aes(fill = prop_young)) +
  theme_bw()

####################################

# UNEMPLOYMENT CODE
unemp <- read_csv('data/raw_data/2021_census/Unemployment_SA2_code_Brisbane_2021_R.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()

prop_unemp <- unemp %>%
  select(sa1_code_2021,
         unemployed,
         total)

prop_unemp <- mutate(prop_unemp,
                   prop_unemp = unemployed / total)

for (row in 1:nrow(prop_unemp)) {
  prop_unemp$prop_unemp[row] <- min(prop_unemp$prop_unemp[row], 1)
}

skim(prop_unemp)

# returns tibble
prop_unemp %>%
  full_join(bris_sa1, by = c('sa1_code_2021' = 'SA1_CODE21'))

write.csv(prop_unemp, 'data/processed_data/SA1/unemployed2021.csv', row.names = FALSE)

prop_unemp_sf <- merge(bris_sa1, prop_unemp, by.x = "SA1_CODE21", by.y = "sa1_code_2021", all = TRUE)

ggplot() +
  geom_sf(data = prop_unemp_sf, aes(fill = prop_unemp)) +
  theme_bw()

####################################

# ESL CODE
# esl <- read_csv('data/raw_data/2021_census/English_proficiency_and_other_language_SA2_code_Brisbane_2021_R.csv') %>%
#   na.locf(fromLast=FALSE) %>%
#   clean_names()
# 
# # Select relevant columns only
# prop_esl <- esl %>%
#   select(sa1_code_2021,
#          uses_other_language_and_speaks_english_not_well,
#          uses_other_language_and_speaks_english_not_at_all,
#          total)
# 
# # Calculate proportion
# prop_esl <- mutate(prop_esl,
#                    prop_esl = (uses_other_language_and_speaks_english_not_well +
#                                    uses_other_language_and_speaks_english_not_at_all) /
#                      total)
# 
# # Deal with percentages over 100% caused by data randomness
# for (row in 1:nrow(prop_esl)) {
#   prop_esl$prop_esl[row] <- min(prop_esl$prop_esl[row], 1)
# }
# 
# # Get summary
# skim(prop_esl)
# 
# # returns tibble
# prop_esl %>%
#   full_join(bris_sa1, by = c('sa1_code_2021' = 'SA1_CODE21'))
# 
# # Write to csv
# write.csv(prop_esl, 'data/processed_data/SA1/esl2021.csv', row.names = FALSE)
# 
# prop_esl_sf <- merge(bris_sa1, prop_esl, by.x = "SA1_CODE21", by.y = "sa1_code_2021", all = TRUE)
# 
# ggplot() +
#   geom_sf(data = prop_esl_sf, aes(fill = prop_esl)) +
#   theme_bw() 

####################################

# INDIGENOUS CODE
# indigenous <- read_csv('data/raw_data/2021_census/Indigenous_SA2_code_Brisbane_2021_R.csv') %>%
#   na.locf(fromLast=FALSE) %>%
#   clean_names()
# 
# # Select relevant columns only
# prop_indigenous <- indigenous %>%
#   select(sa1_code_2021,
#          aboriginal,
#          torres_strait_islander,
#          both_aboriginal_and_torres_strait_islander,
#          total)
# 
# # Calculate proportion
# prop_indigenous <- mutate(prop_indigenous,
#                           prop_indigenous = (aboriginal +
#                                                torres_strait_islander +
#                                                both_aboriginal_and_torres_strait_islander) /
#                             total)
# 
# # Deal with percentages over 100% caused by data randomness
# for (row in 1:nrow(prop_indigenous)) {
#   prop_indigenous$prop_indigenous[row] <- min(prop_indigenous$prop_indigenous[row], 1)
# }
# 
# # Get summary
# skim(prop_indigenous)
# 
# colnames(prop_indigenous)[1] <- 'SA1_CODE21'
# a <- merge(prop_indigenous, bris_sa1, by = 'SA1_CODE21', all = TRUE)
# b <- a[, c("SA1_CODE21", "aboriginal", "torres_strait_islander", 
#            "both_aboriginal_and_torres_strait_islander", "total",
#            "prop_indigenous")]
# 
# # Write to csv
# write.csv(b, 'data/processed_data/SA1/indigenous2021.csv', row.names = FALSE)
# 
# prop_indigenous_sf <- merge(bris_sa1,
#                             prop_indigenous,
#                             by.x = "SA1_CODE21",
#                             by.y = "SA1_CODE21",
#                             all.x = TRUE,
#                             all = TRUE)
# 
# ggplot() +
#   geom_sf(data = prop_indigenous_sf, aes(fill = prop_indigenous)) +
#   theme_bw()

####################################

# LONGTERM HEALTH CONDITIONS CODE
# health_cond <- read_csv('data/raw_data/2021_census/Long-term_Health_Conditions_SA2_code_Brisbane_2021_R.csv') %>%
#   na.locf(fromLast=FALSE) %>%
#   clean_names()
# 
# Select relevant columns only
# prop_health_cond <- health_cond %>%
#   select(sa1_code_2021,
#          one_condition,
#          two_conditions,
#          three_or_more_conditions,
#          total)
# 
# # Calculate proportion
# prop_health_cond <- mutate(prop_health_cond,
#                            prop_health_cond = (one_condition +
#                                                  two_conditions +
#                                                  three_or_more_conditions) /
#                              total)
# 
# # Deal with percentages over 100% caused by data randomness
# for (row in 1:nrow(prop_health_cond)) {
#   prop_health_cond$prop_health_cond[row] <- min(prop_health_cond$prop_health_cond[row], 1)
# }
# 
# # Get summary
# skim(prop_health_cond)
# 
# # returns tibble
# prop_health_cond %>%
#   full_join(bris_sa1, by = c('sa1_code_2021' = 'SA1_CODE21'))
# 
# colnames(prop_health_cond)[1] <- 'SA1_CODE21'
# a <- merge(prop_health_cond, bris_sa1, by = 'SA1_CODE21', all = TRUE)
# b <- a[, c("SA1_CODE21", "one_condition", "two_conditions",
#            "three_or_more_conditions", "total",
#            "prop_health_cond")]
# 
# # Write to csv
# write.csv(b, 'data/processed_data/SA1/long-term_health_cond2021.csv', row.names = FALSE)
# 
# prop_health_cond_sf <- merge(bris_sa1,
#                              prop_health_cond,
#                              by.x = "SA1_CODE21",
#                              by.y = "SA1_CODE21",
#                              all.x = TRUE,
#                              all = TRUE)
# 
# ggplot() +
#   geom_sf(data = prop_health_cond_sf, aes(fill = prop_health_cond)) +
#   theme_bw()

####################################

# POPULATION CODE
# pop2021 <- read_csv('data/raw_data/2021_census/Population_SA2_code_Brisbane_2021_new_R.csv') %>%
#   na.locf(fromLast=FALSE) %>%
#   clean_names()
# POPULATION CODE
# # Select relevant columns only
# pop_2021 <- pop2021 %>%
#   select(sa1_code_2021,
#          total)
# 
# # returns tibble
# pop_2021 %>%
#   full_join(bris_sa1, by = c('sa1_code_2021' = 'SA1_CODE21'))
# 
# # Write to csv
# write.csv(pop_2021, 'data/processed_data/SA1/Population2021.csv', row.names = FALSE)
# POPULATION CODE
# pop_2021_sf <- merge(bris_sa1,
#                      pop_2021,
#                      by.x = "SA1_CODE21",
#                      by.y = "sa1_code_2021",
#                      all = TRUE)
# POPULATION CODE
# pop_2021_sf <- pop_2021_sf[pop_2021_sf$SA1_CODE21 != "Total",]
# ggplot() +
#   geom_sf(data = pop_2021_sf, aes(fill = total)) +
#   theme_bw()

####################################

# FAMILY DWELLING CODE
familydwell <- read_csv('data/raw_data/2021_census/Family_Household_Compostition_SA2_code_Brisbane_2021_R.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
# FAMILY DWELLING CODE
# Select relevant columns only
prop_familydwell <- familydwell %>%
  select(sa1_code_2021,
         one_family_household_one_parent_family,
         one_family_household_other_family,
         two_family_household_couple_family_with_no_children,
         two_family_household_couple_family_with_children,
         two_family_household_one_parent_family,
         two_family_household_other_family,
         three_or_more_family_household_couple_family_with_no_children,
         three_or_more_family_household_couple_family_with_children,
         three_or_more_family_household_one_parent_family,
         three_or_more_family_household_other_family,
         total)

# Calculate proportion
prop_familydwell <- mutate(prop_familydwell,
                           prop_familydwell = (one_family_household_one_parent_family +
                                                 one_family_household_other_family +
                                                 two_family_household_couple_family_with_no_children +
                                                 two_family_household_couple_family_with_children +
                                                 two_family_household_one_parent_family +
                                                 two_family_household_other_family +
                                                 three_or_more_family_household_couple_family_with_no_children +
                                                 three_or_more_family_household_couple_family_with_children +
                                                 three_or_more_family_household_one_parent_family +
                                                 three_or_more_family_household_other_family) /
                             total)

# Deal with percentages over 100% caused by data randomness
for (row in 1:nrow(prop_familydwell)) {
  prop_familydwell$prop_familydwell[row] <- min(prop_familydwell$prop_familydwell[row], 1)
}

# Get summary
skim(prop_familydwell)

# returns tibble
prop_familydwell %>%
  full_join(bris_sa1, by = c('sa1_code_2021' = 'SA1_CODE21'))

# Write to csv
write.csv(prop_familydwell, 'data/processed_data/SA1/familydwelling2021.csv', row.names = FALSE)

prop_familydwell_sf <- merge(bris_sa1,
                             prop_familydwell,
                             by.x = "SA1_CODE21",
                             by.y = "sa1_code_2021",
                             all = TRUE)

ggplot() +
  geom_sf(data = prop_familydwell_sf, aes(fill = prop_familydwell)) +
  theme_bw()
