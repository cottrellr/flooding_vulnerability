### ------------------------------------------------------------------------ ###
### --------------- CODE FOR CREATION OF VULNERABILITY INDEX --------------- ###
### ------------------------------------------------------------------------ ###



### Libraries: ------------------------------------------------------------- ###
### ------------------------------------------------------------------------ ###
library(sf)
library(tidyverse)
library(dplyr)
library(here)
library(data.table)





### SHAPEFILE LOADING: ----------------------------------------------------- ###
### ------------------------------------------------------------------------ ###
BRIS <- read_sf("../../data/spatial/SA2_2021_BRIS_SHAPE","SA2_2021_BRIS")
DF <- st_drop_geometry(BRIS)[,1]
fPath <- "../../data/processed_data/"
fPath2 <- "../../data/data_products/"


### RANKING FUNCTION: ------------------------------------------------------ ###
### ------------------------------------------------------------------------ ###
rankSpatial <- function(dummy){
  for (i in 2:ncol(dummy)){
    dummy[,i] <- frank(as.numeric(dummy[,i]),
                       na.last = "keep",
                       ties.method = c("min")
    )/length(dummy[,i])
    if(sum(dummy[,i], na.rm=T)==length(dummy[,i])){ # If the whole column was originally equal.
      dummy[,i] <- 0
    }
  }
  return(dummy)
}





### EXPOSURE (HIGH -> MORE VULNERABLE): ------------------------------------ ###
### ------------------------------------------------------------------------ ###
DF_E <- DF

# Inundation:
DATASET_E <- c("sa2_inundation")
for (i in 1:length(DATASET_E)){
  new <- read.csv(paste0(fPath2,DATASET_E[i],".csv"))
  new <- new[,c(1,ncol(new))]
  names(new)[1] <- "SA2_CODE21"
  DF_E <- merge(DF_E,new)
}

DF_E <- rankSpatial(DF_E)
if(ncol(DF_E) == 2){ # Quick counter-measure while inundation is our only exposure parameter.
  DF_E <- cbind(DF_E, "EXP" = DF_E[,2])
} else {
  DF_E <- cbind(DF_E, "EXP" = frank(rowSums(DF_E[,2:ncol(DF_E)]), na.last = "keep", ties.method = c("min"))/nrow(DF_E))
}

PLOT <- merge(BRIS,DF_E)
ggplot() +
  geom_sf(data=PLOT, aes(fill = EXP), color=NA) +
  geom_sf(data=PLOT, fill=NA, color="black") +
  theme_void() +
  labs(fill="Exposure (%)")




### SENSITIVITY (HIGH -> MORE VULNERABLE): --------------------------------- ###
### ------------------------------------------------------------------------ ###
DF_S <- DF

# ABS Demographics:
DATASET_S <- c("disabl2021","dwell_house2021","edu2021","vulnrbl_young2021")
for (i in 1:length(DATASET_S)){
  new <- read.csv(paste0(fPath,DATASET_S[i],".csv"))
  new <- new[,c(1,ncol(new))]
  names(new)[1] <- "SA2_CODE21"
  DF_S <- merge(DF_S,new)
}

DF_S <- rankSpatial(DF_S)
DF_S <- cbind(DF_S, "SEN" = frank(rowSums(DF_S[,2:ncol(DF_S)]), na.last = "keep", ties.method = c("min"))/nrow(DF_S))

PLOT <- merge(BRIS,DF_S)
ggplot() +
  geom_sf(data=PLOT, aes(fill = SEN), color=NA) +
  geom_sf(data=PLOT, fill=NA, color="black") +
  theme_void() +
  labs(fill="Sensitivity (%)")





### ADAPTIVE CAPACITY (HIGH -> MORE VULNERABLE): --------------------------- ###
### ------------------------------------------------------------------------ ###
DF_A <- DF

# Distance to services:
DATASET_A <- c("dAmbu","dBuss","dFire","dHosp","dPets","dPoli","dSesf","dShop")
for (i in 1:length(DATASET_A)){
  new <- read.csv(paste0(fPath,DATASET_A[i],".csv"))[,-1]
  DF_A <- merge(DF_A,new)
}

DF_A <- rankSpatial(DF_A)
DF_A <- cbind(DF_A, "AC" = frank(rowSums(DF_A[,2:ncol(DF_A)]), na.last = "keep", ties.method = c("min"))/nrow(DF_A))

PLOT <- merge(BRIS,DF_A)
ggplot() +
  geom_sf(data=PLOT, aes(fill = AC), color=NA) +
  geom_sf(data=PLOT, fill=NA, color="black") +
  theme_void() +
  labs(fill="Adaptive Capacity (%)")





### VULNERABILITY (HIGH -> MORE VULNERABLE): ------------------------------- ###
### ------------------------------------------------------------------------ ###

DF_V <- merge(DF_E,DF_S) %>% merge(DF_A)
dummy <- cbind(DF_V$EXP,DF_V$SEN,DF_V$AC)
DF_V <- cbind(DF_E, "VI" = frank(rowSums(dummy), na.last = "keep", ties.method = c("min"))/nrow(dummy))

PLOT <- merge(BRIS,DF_V)
ggplot() +
  geom_sf(data=PLOT, aes(fill = VI), color=NA) +
  geom_sf(data=PLOT, fill=NA, color="black") +
  theme_void() +
  labs(fill="Vulnerability (%)")










# ---------------------------------------------------------------------------- #