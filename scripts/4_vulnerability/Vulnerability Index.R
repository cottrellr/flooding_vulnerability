### ------------------------------------------------------------------------ ###
### --------------- CODE FOR CREATION OF VULNERABILITY INDEX --------------- ###
### ------------------------------------------------------------------------ ###



### Libraries: ------------------------------------------------------------- ###
### ------------------------------------------------------------------------ ###
library(sf)
library(tidyverse)
library(dplyr)
library(here)
library(data.table)





### SHAPEFILE LOADING: ----------------------------------------------------- ###
### ------------------------------------------------------------------------ ###
BRIS <- read_sf("../../data/spatial/SA2_2021_BRIS_SHAPE","SA2_2021_BRIS")
DF <- st_drop_geometry(BRIS)[,1]
fPath <- "../../data/processed_data/"


### RANKING FUNCTION: ------------------------------------------------------ ###
### ------------------------------------------------------------------------ ###
rankSpatial <- function(dummy){
  dummy <- frank(as.numeric(dummy),
                 na.last = "keep",
                 ties.method = c("min")
                 )/length(as.numeric(dummy))
  if(sum(dummy, na.rm=T)==length(dummy)){ # If the whole column was originally equal.
    dummy <- 0
    }
  return(dummy)
}





### ADAPTIVE CAPACITY (HIGH -> MORE VULNERABLE): --------------------------- ###
### ------------------------------------------------------------------------ ###
DF_A <- DF

# Distance to services:
DATASET_A <- c("dAmbu","dBuss","dFire","dHosp","dPets","dPoli","dSesf","dShop")
for (i in 1:length(DATASET_A)){
  new <- read.csv(paste0(fPath,DATASET_A[i],".csv"))[,-1]
  DF_A <- merge(DF_A,new)
}

DF_A <- cbind(DF_A, "AC" = frank(rowSums(DF_A[,2:ncol(DF_A)]), na.last = "keep", ties.method = c("min"))/nrow(DF_A))

PLOT <- merge(BRIS,DF_A)
ggplot() +
  geom_sf(data=PLOT, aes(fill = AC), color=NA) +
  geom_sf(data=PLOT, fill=NA, color="black") +
  theme_void() +
  labs(fill="Adaptive Capacity (%)")





### ADAPTIVE CAPACITY (HIGH -> MORE VULNERABLE): --------------------------- ###
### ------------------------------------------------------------------------ ###
DF_S <- DF

# ABS Demographics:
DATASET_S <- c("disabl2021","dwell_house2021","edu2021","vulnrbl_young2021")
for (i in 1:length(DATASET_S)){
  new <- read.csv(paste0(fPath,DATASET_S[i],".csv"))
  new <- new[,c(2,ncol(new))]
  DF_S <- merge(DF_S,new)
}





















# ---------------------------------------------------------------------------- #