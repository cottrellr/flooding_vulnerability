# Required libraries
library(ggplot2)
library(dplyr)
library(tidyr)
library(waffle)

# Data: Extract the relevant weights manually based on the Excel structure
vi_data <- data.frame(
  Component = c(rep("Exposure", 1), rep("Sensitivity", 11), rep("Adaptive Capacity", 6)),
  Factor = c("Flood Exposure", 
             "Disability prevalence", "Dwelling type", "Education level", "Vulnerable age (young)", 
             "Vulnerable age (old)", "Unemployment rate", "English as a second language", 
             "Indigenous population", "Long-term health conditions", "Population Density",
             "Family Composition", 
             "Ambulance stations", "Bus stops", "Fire stations", 
             "Hospitals", "Police stations", "Retail services"),
  Weight = c(1/3, 
             rep((1/3)/11, 11), 
             rep((1/3)/6, 6))
)

# Create a stacked bar chart
colourVec <- c(Exposure = "steelblue", 
               Sensitivity = "lightgoldenrod", 
               "Adaptive Capacity" = "salmon")

ggplot(vi_data, aes(x = reorder(Factor, -Weight), 
                    y = Weight, 
                    fill = Component)) +
  geom_bar(position="stack", stat = "identity") +
  theme_minimal() +
  scale_fill_manual(values = colourVec) +
  labs(title = "Assumed Weightings for Vulnerability Index Components",
       x = "VI Component", 
       y = "Normalized Weight",
       fill = "Factors") +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) +
  coord_flip()

# Create an alluvial diagram
vi_data$Factor <- with(vi_data, reorder(Factor, Weight))
vi_data$Component <- with(vi_data, reorder(Component, Weight))
ggplot(vi_data, 
       aes(y = Weight,
           axis1 = Component, axis2 = reorder(Factor, Component),
           fill = Component)) +
  geom_alluvium(width = 2/3) +
  scale_fill_manual(values = colourVec) +
  geom_stratum(width = 2/3,
               inherit.aes = TRUE) +
  geom_text(stat = "stratum", 
            aes(label = after_stat(stratum))) +
  # geom_text(stat = "alluvium", aes(label = round(Weight, 2))) +
  scale_x_discrete(limits = c("VI Component", "Data")) +
  theme_minimal() +
  labs(title = "Assumed Weightings for Vulnerability Index Components",
       x = "VI Component", 
       y = "Weight",
       fill = "Component") +
  # Remove legend
  theme(legend.position = "none") +
  theme(plot.margin=grid::unit(c(0.5,0.5,0.5,0.5), "mm"))

# Save plot
ggsave(filename = "VI_weightings.jpg", 
       width = 8, height = 6, dpi = 300)
