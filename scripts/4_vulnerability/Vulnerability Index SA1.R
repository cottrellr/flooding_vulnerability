### ------------------------------------------------------------------------ ###
### ------------- CODE FOR CREATION OF VULNERABILITY INDEX SA1 ------------- ###
### ------------------------------------------------------------------------ ###


### Libraries: ------------------------------------------------------------- ###
### ------------------------------------------------------------------------ ###
library(sf)
library(tidyverse)
library(dplyr)
library(here)
library(data.table)
library(corrplot)


### SHAPEFILE LOADING: ----------------------------------------------------- ###
### ------------------------------------------------------------------------ ###
BRIS <- read_sf("../../data/spatial/SA1_Bris","bris_sa1")
DF <- st_drop_geometry(BRIS)[,1]
fPath <- "../../data/processed_data/"
fPath2 <- "../../data/data_products/"


### RANKING FUNCTION: ------------------------------------------------------ ###
### ------------------------------------------------------------------------ ###
rankSpatial <- function(dummy){
  for (i in 2:ncol(dummy)){
    dummy[,i] <- frank(as.numeric(dummy[,i]),
                       na.last = "keep",
                       ties.method = c("min")
    )/length(dummy[,i])
    # If the whole column was originally equal,
    if(sum(dummy[,i], na.rm=T)==length(dummy[,i])){ 
      dummy[,i] <- 0
    }
  }
  return(dummy)
}

### EXPOSURE (HIGH -> MORE VULNERABLE): ------------------------------------ ###
### ------------------------------------------------------------------------ ###
DF_E <- DF

# Inundation:
DATASET_E <- c("sa1_inundation")
for (i in 1:length(DATASET_E)){
  new <- read.csv(paste0(fPath2,DATASET_E[i],".csv"))
  new <- new[,c(1,ncol(new))]
  names(new)[1] <- "SA1_CODE21"
  DF_E <- merge(DF_E,new)
}

DF_E <- rankSpatial(DF_E)
if(ncol(DF_E) == 2){ # Quick counter-measure while inundation is our only exposure parameter.
  DF_E <- cbind(DF_E, "EXP" = DF_E[,2])
} else {
  DF_E <- cbind(DF_E, "EXP" = frank(rowSums(DF_E[,2:ncol(DF_E)]), na.last = "keep", ties.method = c("min"))/nrow(DF_E))
}

PLOT <- merge(BRIS,DF_E)
ggplot() +
  geom_sf(data=PLOT, aes(fill = EXP), color="black") +
  theme_void() +
  # scale_fill_gradientn(colours = c("#C3DFCC", "#81C3D1",  "#579cc6", "#406ba8", "#2a3b8a", "#1b1f5d")) +
  scale_fill_distiller(direction = 1) +
  labs(fill="Exposure (%)")




### SENSITIVITY (HIGH -> MORE VULNERABLE): --------------------------------- ###
### ------------------------------------------------------------------------ ###
DF_S <- DF

# Average for each theme, then average across themes

# ABS Demographics:
DATASET_S <- c("disabl2021",
               "dwell_house2021",
               "edu2021",
               "vulnerable_young2021",
               "vulnerable_old2021",
               "unemployed2021",
               "esl2021", 
               "indigenous2021",
               "long-term_health_cond2021", 
               "Population2021",
               "familydwelling2021")

for (i in 1:length(DATASET_S)){
  new <- read.csv(paste0(fPath,"SA1/",DATASET_S[i],".csv"))
  new <- new[,c(1,ncol(new))]
  names(new)[1] <- "SA1_CODE21"
  DF_S <- merge(DF_S,new)
}

DF_S <- rankSpatial(DF_S)
DF_S <- cbind(DF_S, "SEN" = frank(rowSums(DF_S[,2:ncol(DF_S)]), 
                                  na.last = "keep", 
                                  ties.method = c("min"))/nrow(DF_S))

PLOT <- merge(BRIS,DF_S)
ggplot() +
  geom_sf(data=PLOT, aes(fill = SEN), color="black") +
  # scale_fill_gradientn(colours = c("#f9eb73", "#eec259",  "#e39642", "#d96a2e", "#ae4e29", "#663d2f")) +
  scale_fill_distiller(palette = "YlOrBr", direction = 1) +
  theme_void() +
  labs(fill="Sensitivity (%)")


### ADAPTIVE CAPACITY (HIGH -> MORE VULNERABLE): --------------------------- ###
### ------------------------------------------------------------------------ ###
DF_A <- DF

# Distance to services:
DATASET_A <- c("dAmbu","dBuss","dFire","dHosp","dPets","dPoli","dSesf","dShop")
for (i in 1:length(DATASET_A)){
  new <- read.csv(paste0(fPath,"SA1/",DATASET_A[i],".csv"))[,-1]
  DF_A <- merge(DF_A,new)
}

DF_A <- rankSpatial(DF_A)
DF_A <- cbind(DF_A, "AC" = frank(rowSums(DF_A[,2:ncol(DF_A)]), na.last = "keep", ties.method = c("min"))/nrow(DF_A))

PLOT <- merge(BRIS,DF_A)
ggplot() +
  geom_sf(data=PLOT, aes(fill = AC), color="black") +
  # scale_fill_gradientn(colours = rev(c("#eeb6a3", "#df7890",  "#bd4c8a", "#7e2d91", "#52157f", "#381754"))) +
  scale_fill_distiller(palette = 'YlGn') +
  theme_void() +
  labs(fill="Adaptive Capacity (%)")


### VULNERABILITY (HIGH -> MORE VULNERABLE): ------------------------------- ###
### ------------------------------------------------------------------------ ###

DF_V <- merge(DF_E,DF_S) %>% merge(DF_A)
dummy <- cbind(DF_V$EXP,DF_V$SEN,DF_V$AC)
DF_V <- cbind(DF_V, "VI" = frank(rowSums(dummy), 
                                 na.last = "keep", 
                                 ties.method = c("min"))/nrow(dummy))

PLOT <- merge(BRIS,DF_V)
ggplot() +
  geom_sf(data=PLOT, aes(fill = VI), color="black") +
  scale_fill_viridis_c(option = "rocket", direction = -1, begin = 0.2) +
  # scale_fill_distiller(palette = 'BuPu', direction = 1) +
  theme_void() +
  labs(fill="Vulnerability (%)")

# Correlation plot:
corrplot(cor(DF_V[,2:ncol(DF_V)],use="complete.obs"))



# ---------------------------------------------------------------------------- #