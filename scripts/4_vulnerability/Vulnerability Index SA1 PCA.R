### ------------------------------------------------------------------------ ###
### ------------- CODE FOR CREATION OF VULNERABILITY INDEX SA1 ------------- ###
### ------------------------------------------------------------------------ ###


### Libraries: ------------------------------------------------------------- ###
### ------------------------------------------------------------------------ ###
library(sf)
library(tidyverse)
library(dplyr)
library(here)
library(data.table)
library(corrplot)


### SHAPEFILE LOADING: ----------------------------------------------------- ###
### ------------------------------------------------------------------------ ###
BRIS <- read_sf("../../data/spatial/SA1_Bris","bris_sa1")
DF <- st_drop_geometry(BRIS)[,1]
fPath <- "../../data/processed_data/"
fPath2 <- "../../data/data_products/"


### NORMALISING FUNCTION: -------------------------------------------------- ###
### ------------------------------------------------------------------------ ###
normaliseData <- function(dummy){
  for (i in 2:ncol(dummy)){
    # Avoid modifying columns if they have a single unique value or are NA
    if(length(unique(dummy[,i])) > 1){
      dummy[,i] <- scale(dummy[,i])
    }
  }
  return(dummy)
}

### EXPOSURE (HIGH -> MORE VULNERABLE): ------------------------------------ ###
### ------------------------------------------------------------------------ ###
DF_E <- DF

# Inundation:
DATASET_E <- c("sa1_inundation")
for (i in 1:length(DATASET_E)){
  new <- read.csv(paste0(fPath2,DATASET_E[i],".csv"))
  new <- new[,c(1,ncol(new))]
  names(new)[1] <- "SA1_CODE21"
  DF_E <- merge(DF_E,new)
}

# Normalise instead of rank
DF_E <- normaliseData(DF_E)

if(ncol(DF_E) == 2){
  # Quick counter-measure while inundation is our only exposure parameter
  DF_E <- cbind(DF_E, "EXP" = DF_E[,2])
} 

# Does it look normally distributed? If not, apply a transform
hist(DF_E$EXP, breaks = 100) # Definitely right-skewed, so use log tform
DF_E$EXP <- log(DF_E$EXP + 1) # Adding 1 to avoid log(0)
hist(DF_E$EXP, breaks = 100) # Still right-skewed

# Plot Exposure (Revisit to adjust score representation)
PLOT <- merge(BRIS,DF_E)
ggplot() +
  geom_sf(data=PLOT, aes(fill = EXP), color="black") +
  theme_void() +
  # scale_fill_gradientn(colours = c("#C3DFCC", "#81C3D1",  "#579cc6", "#406ba8", "#2a3b8a", "#1b1f5d")) +
  scale_fill_distiller(direction = 1) +
  labs(fill="Exposure Score")


### SENSITIVITY (HIGH -> MORE VULNERABLE): --------------------------------- ###
### ------------------------------------------------------------------------ ###
DF_S <- DF

# Set sensitivity themes & variables within themes
S_THEMES <- list(
  # Socioeconomic Status (missing income status)
  soc_econ_stat = c("Population2021",
                    "edu2021",
                    "unemployed2021"),
  # Household Composition (missing single parents, living alone)
  house_comp = c("vulnerable_young2021",
                 "vulnerable_old2021",
                 "disabl2021"),
  # Language and Culture
  lang_culture = c("esl2021", 
                   "indigenous2021"),
  # Housing Conditions
  house_cond = c("dwell_house2021",
                 "familydwelling2021"),
  # Health Status 
  health_stat = c("long-term_health_cond2021")
  # Health Risk Factors 
  #health_risk = c()
  )

# ABS Demographics:
DATASET_S <- c("disabl2021",
               "dwell_house2021",
               "edu2021",
               "vulnerable_young2021",
               "vulnerable_old2021",
               "unemployed2021",
               "esl2021",
               "indigenous2021",
               "long-term_health_cond2021",
               "Population2021",
               "familydwelling2021")

# Read the files for each of the sensitivity elements
for (i in 1:length(DATASET_S)){
  new <- read.csv(paste0(fPath,"SA1/",DATASET_S[i],".csv"))
  new <- new[,c(1,ncol(new))]
  names(new)[1] <- "SA1_CODE21"
  DF_S <- merge(DF_S,new)
}

# Normalise 

# (Change to) PCA for each theme
DF_S <- rankSpatial(DF_S)

# (Change to) PCA across themes
DF_S <- cbind(DF_S, "SEN" = frank(rowSums(DF_S[,2:ncol(DF_S)]), 
                                  na.last = "keep", 
                                  ties.method = c("min"))/nrow(DF_S))

PLOT <- merge(BRIS,DF_S)
ggplot() +
  geom_sf(data=PLOT, aes(fill = SEN), color="black") +
  # scale_fill_gradientn(colours = c("#f9eb73", "#eec259",  "#e39642", "#d96a2e", "#ae4e29", "#663d2f")) +
  scale_fill_distiller(palette = "YlOrBr", direction = 1) +
  theme_void() +
  labs(fill="Sensitivity (%)")


### ADAPTIVE CAPACITY (HIGH -> MORE VULNERABLE): --------------------------- ###
### ------------------------------------------------------------------------ ###
DF_A <- DF

# Distance to services:
DATASET_A <- c("dAmbu","dBuss","dFire","dHosp","dPets","dPoli","dSesf","dShop")
for (i in 1:length(DATASET_A)){
  new <- read.csv(paste0(fPath,"SA1/",DATASET_A[i],".csv"))[,-1]
  DF_A <- merge(DF_A,new)
}

DF_A <- rankSpatial(DF_A)
DF_A <- cbind(DF_A, "AC" = frank(rowSums(DF_A[,2:ncol(DF_A)]), na.last = "keep", ties.method = c("min"))/nrow(DF_A))

PLOT <- merge(BRIS,DF_A)
ggplot() +
  geom_sf(data=PLOT, aes(fill = AC), color="black") +
  # scale_fill_gradientn(colours = rev(c("#eeb6a3", "#df7890",  "#bd4c8a", "#7e2d91", "#52157f", "#381754"))) +
  scale_fill_distiller(palette = 'YlGn') +
  theme_void() +
  labs(fill="Adaptive Capacity (%)")


### VULNERABILITY (HIGH -> MORE VULNERABLE): ------------------------------- ###
### ------------------------------------------------------------------------ ###

DF_V <- merge(DF_E,DF_S) %>% merge(DF_A)
dummy <- cbind(DF_V$EXP,DF_V$SEN,DF_V$AC)
DF_V <- cbind(DF_V, "VI" = frank(rowSums(dummy), 
                                 na.last = "keep", 
                                 ties.method = c("min"))/nrow(dummy))

PLOT <- merge(BRIS,DF_V)
ggplot() +
  geom_sf(data=PLOT, aes(fill = VI), color="black") +
  scale_fill_viridis_c(option = "rocket", direction = -1, begin = 0.2) +
  # scale_fill_distiller(palette = 'BuPu', direction = 1) +
  theme_void() +
  labs(fill="Vulnerability (%)")

# Correlation plot:
corrplot(cor(DF_V[,2:ncol(DF_V)],use="complete.obs"))



# ---------------------------------------------------------------------------- #