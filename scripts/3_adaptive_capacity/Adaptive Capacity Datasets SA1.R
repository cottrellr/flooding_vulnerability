### ------------------------------------------------------------------------ ###
### --------- CODE FOR CREATION OF ADAPTIVE CAPACITY DATASETS SA1 ---------- ###
### ------------------------------------------------------------------------ ###


### Libraries: ------------------------------------------------------------- ###
### ------------------------------------------------------------------------ ###
library(sf)
library(dplyr)
library(ggplot2)
library(stringr)
library(geosphere)


### SHAPEFILE LOADING: ----------------------------------------------------- ###
### ------------------------------------------------------------------------ ###

BRIS <- read_sf("../../data/spatial/SA1_Bris","bris_sa1")
CENT <- as.data.frame(as_Spatial(st_centroid(BRIS)$geometry))
LonRange <- c(min(CENT$coords.x1), max(CENT$coords.x1))
LonRange <- c(152.7,153.4)
LatRange <- c(min(CENT$coords.x2), max(CENT$coords.x2))
LatRange <- c(-27.75,-27.25)


### INDICATOR: Distance from SA1 centroid to nearest Hospital -------------- ###
### ------------------------------------------------------------------------ ###

HOSP <- read.csv("../../data/raw_data/Brisbane_hospital.csv") %>%
  filter(Latitude > LatRange[1]) %>%
  filter(Latitude < LatRange[2]) %>%
  filter(Longitude > LonRange[1]) %>%
  filter(Longitude < LonRange[2])

dMat <- c()
for (i in 1:nrow(HOSP)){
  new <- distm(CENT, c(HOSP$Longitude[i], HOSP$Latitude[i]), fun = distHaversine)
  dMat <- cbind(dMat, new)
}
BRIS$dHosp <- apply(dMat, 1, FUN = min)/1000

ggplot() +
  geom_sf(data=BRIS, aes(fill = dHosp), color=NA) +
  geom_sf(data=BRIS, fill=NA, color="black") +
  geom_point(data=HOSP, aes(y=Latitude, x=Longitude), color="red")

dHosp <- st_drop_geometry(BRIS[,c("SA1_CODE21", "dHosp")])
write.csv(dHosp, "../../data/processed_data/SA1/dHosp.csv")


### INDICATOR: Distance from SA1 centroid to nearest shops ----------------- ###
### ------------------------------------------------------------------------ ###

SHOP <- read.csv("../../data/raw_data/Qld_shops.csv") %>%
  filter(GEOCODE.LATITUDE > LatRange[1]) %>%
  filter(GEOCODE.LATITUDE < LatRange[2]) %>%
  filter(GEOCODE.LONGITUDE > LonRange[1]) %>%
  filter(GEOCODE.LONGITUDE < LonRange[2])

dMat <- c()
for (i in 1:nrow(SHOP)){
  new <- distm(CENT, c(SHOP$GEOCODE.LONGITUDE[i], SHOP$GEOCODE.LATITUDE[i]), fun = distHaversine)
  dMat <- cbind(dMat, new)
}
BRIS$dShop <- apply(dMat, 1, FUN = min)/1000

ggplot() +
  geom_sf(data=BRIS, aes(fill = dShop), color=NA) +
  geom_sf(data=BRIS, fill=NA, color="black") +
  geom_point(data=SHOP, aes(y=GEOCODE.LATITUDE, x=GEOCODE.LONGITUDE), color="red")

dShop <- st_drop_geometry(BRIS[,c("SA1_CODE21", "dShop")])
write.csv(dShop, "../../data/processed_data/SA1/dShop.csv")


### INDICATOR: Distance from SA1 centroid to nearest Petrol Station -------- ###
### ------------------------------------------------------------------------ ###

Pets <- st_read("../../data/spatial/Petrol_Stations_Australia/PetrolStations.gdb") %>%
  filter(STATE == "Queensland")

Pets <- cbind(Pets, as.data.frame(as_Spatial(Pets$SHAPE))) %>%
  filter(coords.x2 > LatRange[1]) %>%
  filter(coords.x2 < LatRange[2]) %>%
  filter(coords.x1 > LonRange[1]) %>%
  filter(coords.x1 < LonRange[2])

dMat <- c()
for (i in 1:nrow(Pets)){
  new <- distm(CENT, c(Pets$coords.x1[i], Pets$coords.x2[i]), fun = distHaversine)
  dMat <- cbind(dMat, new)
}
BRIS$dPets <- apply(dMat, 1, FUN = min)/1000

ggplot() +
  geom_sf(data=BRIS, aes(fill = dPets), color=NA) +
  geom_sf(data=BRIS, fill=NA, color="black") +
  geom_point(data=Pets, aes(x=coords.x1, y=coords.x2), color="red")

dPets <- st_drop_geometry(BRIS[,c("SA1_CODE21", "dPets")])
write.csv(dPets, "../../data/processed_data/SA1/dPets.csv")


### INDICATOR: Distance from SA1 centroid to nearest Emergency Service ----- ###
### ------------------------------------------------------------------------ ###

Eser <- st_read("../../data/spatial/QSC_QLD emergency service locations/Emergency_services_facilities.shp")

Eser <- cbind(Eser, as.data.frame(as_Spatial(Eser$geometry))) %>%
  filter(coords.x2 > LatRange[1]) %>%
  filter(coords.x2 < LatRange[2]) %>%
  filter(coords.x1 > LonRange[1]) %>%
  filter(coords.x1 < LonRange[2])

ggplot() +
  geom_sf(data=BRIS, fill=NA, color="black") +
  geom_point(data=Eser, aes(x=coords.x1, y=coords.x2), color="red") +
  facet_wrap(~FEATURETYP)

# Ambulance Stations: -------------------------------------------------------- #
dMat <- c()
Ambu <- filter(Eser, FEATURETYP == "Ambulance Station")
for (i in 1:nrow(Ambu)){
  new <- distm(CENT, c(Ambu$coords.x1[i], Ambu$coords.x2[i]), fun = distHaversine)
  dMat <- cbind(dMat, new)
}
BRIS$dAmbu <- apply(dMat, 1, FUN = min)/1000

ggplot() +
  geom_sf(data=BRIS, aes(fill = dAmbu), color=NA) +
  geom_sf(data=BRIS, fill=NA, color="black") +
  geom_point(data=Ambu, aes(x=coords.x1, y=coords.x2), color="red")

dAmbu <- st_drop_geometry(BRIS[,c("SA1_CODE21", "dAmbu")])
write.csv(dAmbu, "../../data/processed_data/SA1/dAmbu.csv")

# Police Stations: ----------------------------------------------------------- #
dMat <- c()
Poli <- filter(Eser, FEATURETYP == "Police Station")
for (i in 1:nrow(Poli)){
  new <- distm(CENT, c(Poli$coords.x1[i], Poli$coords.x2[i]), fun = distHaversine)
  dMat <- cbind(dMat, new)
}
BRIS$dPoli <- apply(dMat, 1, FUN = min)/1000

ggplot() +
  geom_sf(data=BRIS, aes(fill = dPoli), color=NA) +
  geom_sf(data=BRIS, fill=NA, color="black") +
  geom_point(data=Poli, aes(x=coords.x1, y=coords.x2), color="red")

dPoli <- st_drop_geometry(BRIS[,c("SA1_CODE21", "dPoli")])
write.csv(dPoli, "../../data/processed_data/SA1/dPoli.csv")

# State Emergency Service Facilities: ---------------------------------------- #
dMat <- c()
Sesf <- filter(Eser, FEATURETYP == "State Emergency Service Facility")
for (i in 1:nrow(Sesf)){
  new <- distm(CENT, c(Sesf$coords.x1[i], Sesf$coords.x2[i]), fun = distHaversine)
  dMat <- cbind(dMat, new)
}
BRIS$dSesf <- apply(dMat, 1, FUN = min)/1000

ggplot() +
  geom_sf(data=BRIS, aes(fill = dSesf), color=NA) +
  geom_sf(data=BRIS, fill=NA, color="black") +
  geom_point(data=Sesf, aes(x=coords.x1, y=coords.x2), color="red")

dSesf <- st_drop_geometry(BRIS[,c("SA1_CODE21", "dSesf")])
write.csv(dSesf, "../../data/processed_data/SA1/dSesf.csv")

# Fire Stations: ------------------------------------------------------------- #
dMat <- c()
Fire <- filter(Eser, FEATURETYP %in% c("Fire Station Metro", "Fire Station Rural"))
for (i in 1:nrow(Fire)){
  new <- distm(CENT, c(Fire$coords.x1[i], Fire$coords.x2[i]), fun = distHaversine)
  dMat <- cbind(dMat, new)
}
BRIS$dFire <- apply(dMat, 1, FUN = min)/1000

ggplot() +
  geom_sf(data=BRIS, aes(fill = dFire), color=NA) +
  geom_sf(data=BRIS, fill=NA, color="black") +
  geom_point(data=Fire, aes(x=coords.x1, y=coords.x2), color="red")

dFire <- st_drop_geometry(BRIS[,c("SA1_CODE21", "dFire")])
write.csv(dFire, "../../data/processed_data/SA1/dFire.csv")


### INDICATOR: Distance from SA1 centroid to nearest Bus Stop -------------- ###
### ------------------------------------------------------------------------ ###

Buss <- st_read("../../data/spatial/Bus_Stop_locations/Bus_Stop_locations.shp") %>%
  filter(LATITUDE > LatRange[1]) %>%
  filter(LATITUDE < LatRange[2]) %>%
  filter(LONGITUDE > LonRange[1]) %>%
  filter(LONGITUDE < LonRange[2])

dMat <- c()
for (i in 1:nrow(Buss)){
  new <- distm(CENT, c(Buss$LONGITUDE[i], Buss$LATITUDE[i]), fun = distHaversine)
  dMat <- cbind(dMat, new)
}
BRIS$dBuss <- apply(dMat, 1, FUN = min)/1000

ggplot() +
  geom_sf(data=BRIS, aes(fill = dBuss), color=NA) +
  geom_sf(data=BRIS, fill=NA, color="black") +
  geom_point(data=Buss, aes(y=LATITUDE, x=LONGITUDE), color="red")

dBuss <- st_drop_geometry(BRIS[,c("SA1_CODE21", "dBuss")])
write.csv(dBuss, "../../data/processed_data/SA1/dBuss.csv")


### INDICATOR: Distance from SA1 centroid to nearest Ferry Terminal -------- ###
### ------------------------------------------------------------------------ ###

Ferr <- st_read("../../data/spatial/Ferry_Terminal_locations/Ferry_Terminal_locations.shp") %>%
  filter(LATITUDE > LatRange[1]) %>%
  filter(LATITUDE < LatRange[2]) %>%
  filter(LONGITUDE > LonRange[1]) %>%
  filter(LONGITUDE < LonRange[2])

dMat <- c()
for (i in 1:nrow(Ferr)){
  new <- distm(CENT, c(Ferr$LONGITUDE[i], Ferr$LATITUDE[i]), fun = distHaversine)
  dMat <- cbind(dMat, new)
}
BRIS$dFerr <- apply(dMat, 1, FUN = min)/1000

ggplot() +
  geom_sf(data=BRIS, aes(fill = dFerr), color=NA) +
  geom_sf(data=BRIS, fill=NA, color="black") +
  geom_point(data=Ferr, aes(y=LATITUDE, x=LONGITUDE), color="red")

dFerr <- st_drop_geometry(BRIS[,c("SA1_CODE21", "dFerr")])
write.csv(dFerr, "../../data/processed_data/SA1/dFerr.csv")



# ---------------------------------------------------------------------------- #