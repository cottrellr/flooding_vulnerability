---
title: "Inundation of hospitals"
author: "Rich Cottrell"
date: "16/02/2023"
output: pdf_document
---

Setup
```{r}
library(tidyverse)
library(here)
library(sf)
library(janitor)


```


#Bring in Flood awareness layer

```{r}

#Import simplified shapefile

flood_extents_simple <- st_read(here("data/spatial/Flood__Awareness__Extents/Flood__Awareness__Extents__Simplified.shp"))

#check it plots - all good
ggplot()+
  geom_sf(data = flood_extents_simple, fill="lightblue", colour = "grey90", linewidth = NA)+
  theme_bw()

```

Inundation of hospital data
```{r}

hospital_shp <- read_csv(here("data/raw_data/Brisbane_hospital.csv")) |> 
  clean_names() |> 
  drop_na(longitude, latitude) |> 
  st_as_sf(coords = c("longitude", "latitude"), crs = "EPSG:4326") |> 
  st_transform(crs = st_crs(flood_extents_simple))

#check they are in the same crs
st_crs(flood_extents_simple)
st_crs(hospital_shp)

ggplot()+
  geom_sf(data = flood_extents_simple, fill = "lightblue", linewidth = 0.01) +
  geom_sf(data = hospital_shp, colour = "red")+
  theme_bw()

hospital_shp_list <- hospital_shp |> group_by(hospital_name) |> group_split()

this_hospital <- hospital_shp_list[[1]]

hospital_inundation_df <- 
  
  map_df(hospital_shp_list, .f= \(this_hospital){
    
  this_hospital_name <- this_hospital$hospital_name
  
  message("Processing  ", this_hospital_name )
  
  inundated_hospital <- st_intersection(this_hospital, flood_extents_simple)
  
  inundated_or_not <- if_else(condition = nrow(inundated_hospital) > 0, true = "inundated", false = "not inundated")
  
  this_hospital_inundation <- this_hospital |> mutate(inundation = inundated_or_not)
  
  return(this_hospital_inundation)
  
})
  

write_csv(x = hospital_inundation_df, file = here("data/processed_data/inundation_of_services/hospital_inundation.csv"))


```


Inundation of petrol stations 

```{r}
#remotes::install_version("sf", version = '1.0.7', repos = "http://cran.us.r-project.org")

flood_extents_simple <- st_read(here("data/spatial/Flood__Awareness__Extents/Flood__Awareness__Extents__Simplified.shp"))

SA2_bris <- st_read(here("data/spatial/SA2_2021_BRIS_SHAPE/SA2_2021_BRIS.shp")) |> st_transform(crs = st_crs(flood_extents_simple))


# Petrol stations
petrol_stations <- 
  st_read(here("data/spatial/Petrol_Stations_Australia_new/PetrolStations.gdb")) |> 
  st_transform(crs = st_crs(flood_extents_simple))


lga_extent <- st_bbox(flood_extents_simple)

petrol_stations_bris <- 
  petrol_stations |> st_crop(y = lga_extent)



petrol_shp_list <- petrol_stations_bris |> group_by() |> group_split()

this_hospital <- hospital_shp_list[[1]]

hospital_inundation_df <- 
  
  map_df(hospital_shp_list, .f= \(this_hospital){
    
  this_hospital_name <- this_hospital$hospital_name
  
  message("Processing  ", this_hospital_name )
  
  inundated_hospital <- st_intersection(this_hospital, flood_extents_simple)
  
  inundated_or_not <- if_else(condition = nrow(inundated_hospital) > 0, true = "inundated", false = "not inundated")
  
  this_hospital_inundation <- this_hospital |> mutate(inundation = inundated_or_not)
  
  return(this_hospital_inundation)
  
})
  

write_csv(x = hospital_inundation_df, file = here("data/processed_data/inundation_of_services/hospital_inundation.csv"))




  


```



```{r}

```





```{r}
flood_extents_simple <- st_read(here("data/spatial/Flood__Awareness__Extents/Flood__Awareness__Extents__Simplified.shp"))
sa2_bris <- SA2_bris <- st_read(here("data/spatial/SA2_2021_BRIS_SHAPE/SA2_2021_BRIS.shp")) |> st_transform(crs = st_crs(flood_extents_simple))


#check it plots - all good
ggplot()+
  geom_sf(data = sa2_bris, fill = "grey95", linewidth = 0.2)+
  geom_sf(data = flood_extents_simple, fill="lightblue", linewidth = 0.03)+
  theme_bw()

ggsave(filename = here("explore/cottrell_explore/twitter_plot.jpg"), width = 7, height = 5)

```

