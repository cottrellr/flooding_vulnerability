---
title: "Inundation of hospitals"
author: "Rich Cottrell"
date: "16/02/2023"
output: pdf_document
---

Setup
```{r}
library(tidyverse)
library(here)
library(sf)
library(janitor)


```


#Bring in Flood awareness layer

```{r}

#Import simplified shapefile

flood_extents_simple <- st_read(here("data/spatial/Flood__Awareness__Extents/Flood__Awareness__Extents__Simplified.shp"))

#check it plots - all good
ggplot()+
  geom_sf(data = flood_extents_simple, fill="lightblue", colour = "grey90", linewidth = NA)+
  theme_bw()

```

Inundation of hospital data
```{r}

hospital_shp <- read_csv(here("data/raw_data/Brisbane_hospital.csv")) |> 
  clean_names() |> 
  drop_na(longitude, latitude) |> 
  st_as_sf(coords = c("longitude", "latitude"), crs = "EPSG:4326") |> 
  st_transform(crs = st_crs(flood_extents_simple))

#check they are in the same crs
st_crs(flood_extents_simple)
st_crs(hospital_shp)

ggplot()+
  geom_sf(data = flood_extents_simple, fill = "lightblue", linewidth = 0.01) +
  geom_sf(data = hospital_shp, colour = "red")+
  theme_bw()

hospital_shp_list <- hospital_shp |> group_by(hospital_name) |> group_split()

this_hospital <- hospital_shp_list[[1]]

hospital_inundation_df <- 
  
  map_df(hospital_shp_list, .f= \(this_hospital){
    
  this_hospital_name <- this_hospital$hospital_name
  
  message("Processing  ", this_hospital_name )
  
  inundated_hospital <- st_intersection(this_hospital, flood_extents_simple)
  
  inundated_or_not <- if_else(condition = nrow(inundated_hospital) > 0, true = "inundated", false = "not inundated")
  
  this_hospital_inundation <- this_hospital |> mutate(inundation = inundated_or_not)
  
  return(this_hospital_inundation)
  
})
  

write_csv(x = hospital_inundation_df, file = here("data/processed_data/inundation_of_services/hospital_inundation.csv"))


```


Inundation of petrol stations 

```{r}
#remotes::install_version("sf", version = '1.0.7', repos = "http://cran.us.r-project.org")

petrol_stations <- st_read(here("data/spatial/Petrol_Stations_Australia_new/PetrolStations.gdb")) |> 
  filter(STATE )

```

