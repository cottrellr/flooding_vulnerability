---
title: "Explore spatial layers"
author: "Rich Cottrell"
date: "11/03/2022"
output: html_document
---

```{r}
library(sf)
library(tidyverse)
library(janitor)
library(here)
library(rmapshaper)
library(ozmaps)
```

This is the flood awareness extent from from Brisbane City Council. This doesn't define flooding source just overall flooding potential. This mean coastal flooding is also included (unsure at present of the predictions or conditions where this needs to be true i.e. is it tsunami, cyclone, sea level rise etc)
```{r}

flood_extents_shp <- st_read(here("data/spatial/Flood__Awareness__Extents/Flood___Awareness___Extents.shp"))


ggplot()+
  geom_sf(data = flood_extents_shp, fill="lightblue", colour = "grey90", size = 0.01)+
  theme_bw()


```
Historic event extents - read and plot for vis

```{r}

flood_1893 <- st_read(here("data/spatial/QSC_1893/Flood_extent_polygon___February_1893___Brisbane_and_Bremer_Rivers.shp")) 

flood_1974 <- st_read(here("data/spatial/QSC_1974/Flood_extent___Brisbane_and_Ipswich___1974.shp"))

flood_2011 <- st_read(here("data/spatial/QSC_2011/Flood_extent___Queensland___Jan_2011.shp")) |> st_make_valid() #found one feature with invalid spherical geometry and ring that intersects itself



ggplot()+
  geom_sf(data = flood_2011, fill="lightblue", size = 0.01)

ggplot()+
  geom_sf(data=flood_1893, fill="lightblue", size=0.01)

ggplot()+
  geom_sf(data = flood_1974, fill="lightblue", size=0.01)

#sf_use_s2(TRUE)
flood_1893_1974 <- st_union(flood_1893, flood_1974)

flood_1893_1974_2011 <- st_union(flood_1893, flood_1974, flood_2011)

ggplot()+
  geom_sf(data = flood_1893_1974_2011, fill="lightblue", size=0.01)

```
The 2011 data looks stranage so maybe constrain it by the Brisbane LGA region only. For this we can import the LGA layers from ozmaps.

#Brisbane LGA 

```{r}

lgas <- ozmaps::ozmap_data(data = "abs_lga")

bris_lga <- lgas %>% filter(NAME == unique(lgas$NAME)[grep("Brisbane", unique(lgas$NAME))])

bris_lga_bbox <- st_bbox(bris_lga)
```

Look at 2011 shapefile cropped to the BNE LGA. Looks like it's doing the right thing when intersected with the others


```{r}
bris_lga_2011_shp <- st_crop(x= flood_2011, y = bris_lga_bbox)


ggplot()+
  geom_sf(data = bris_lga_2011_shp, fill="lightblue", size=0.01)
```


```{r}
#get the intersection brisbane LGA and the joined flood exposure

floods_within_lga <- st_intersection(bris_lga, flood_1893_1974_2011)



ggplot()+
  geom_sf(data = floods_within_lga, 
          fill= "lightblue", size=NA)+
  theme_bw()


ggsave(here("explore", "cottrell_explore", "flood exposure-1893-1974-2011.jpg"), dpi = 300, width = 18, height = 11, units = "cm")

```


Get major water ways data
```{r}

watercourse <- st_read(here("data/spatial/major_waterways/Major_watercourse_lines.shp"))

bris_watercourse <- watercourse %>% filter(NAME == "Brisbane River") 

ggplot()+
  geom_sf(data= bris_watercourse)


```

Get the SA2 data from (ABS - confirm with connie)
```{r}
SA2_aus <- st_read(here("data/spatial/sa2_2016_aust_shape/SA2_2016_AUST.shp"))

SA2_bris <- SA2_aus %>% 
  filter(STE_NAME16 == "Queensland" & 
           GCC_NAME16 == "Greater Brisbane" & 
           SA4_NAME16 %in%  c("Brisbane - East","Brisbane - North", "Brisbane - South", "Brisbane - West", "Brisbane Inner City"))

ggplot()+
  geom_sf(data= SA2_bris)


#get the intersection of the Brisbane LGA with the S2 data for greater brisbane - this is good for display purposes but actually needs filtering by SA2 included within Bris LGA
SA2_bris_lga <- st_intersection(SA2_bris, bris_lga)

SA2_bris_lga <- sf::st_crop(x = SA2_bris_lga, st_bbox(floods_within_lga)) |> mutate(centroids = st_centroid(SA2_bris_lga)$geometry)


ggplot()+
  geom_sf(data = SA2_bris_lga)


SA2_bris_lga 

#so maybe find those SA2 regions in the housing data?

read_csv(here("data/raw_data/Unit_House_STRD_Household_HHCD_SA2_Brisbane.csv")) |> 
  row_to_names(row_number = 1) |> 
  select(1:3) |> 
  filter(SA2!= "Total") |> 
  filter(!is.na(SA2)) |> 
  mutate(SA)
  pull(SA2) |> 
  unique()


  
  unique(SA2_bris$SA4_NAME16)


```


```{r}
ggplot()+
  # geom_sf(data= st_crop(SA2_bris_lga, bris_lga_bbox), aes(fill=AREASQKM16), size= 0.1, alpha=0.1)+
  # geom_sf(data = floods_within_lga, fill = "lightblue", colour = NA)+
  # theme_bw()+
  geom_point(data = SA2_bris_lga |> select(-geometry))
  # scale_fill_gradientn(colours = rev(RColorBrewer::brewer.pal(n=9, name="RdPu")))+
  # guides(fill=FALSE)




```

Join income to SA2 polygons
```{r}





```

