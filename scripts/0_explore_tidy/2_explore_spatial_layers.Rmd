---
title: "Explore spatial layers"
author: "Rich Cottrell"
date: "11/03/2022"
output: html_document
---

```{r}
library(sf)
library(tidyverse)
library(janitor)
library(here)
library(rmapshaper)
library(ozmaps)
```

This is the flood awareness extent from from Brisbane City Council. This doesn't define flooding source just overall flooding potential. This mean coastal flooding is also included (unsure at present of the predictions or conditions where this needs to be true i.e. is it tsunami, cyclone, sea level rise etc).

We can use this as the inundation layer. _ Check with Aiden.

```{r}

flood_extents_shp <- st_read(here("data/spatial/Flood__Awareness__Extents/Flood___Awareness___Extents.shp"))


ggplot()+
  geom_sf(data = flood_extents_shp, fill="lightblue", colour = "grey90", size = 0.01)+
  theme_bw()


```


Historic event extents - read and plot for vis.

Joining all layers for flood events is yuck so we can leave it for now and use the flood awareness layers.

```{r}

flood_1893 <- st_read(here("data/spatial/QSC_1893/Flood_extent_polygon___February_1893___Brisbane_and_Bremer_Rivers.shp")) 

flood_1974 <- st_read(here("data/spatial/QSC_1974/Flood_extent___Brisbane_and_Ipswich___1974.shp"))

flood_2011 <- st_read(here("data/spatial/QSC_2011/Flood_extent___Queensland___Jan_2011.shp")) |> st_make_valid() #found one feature with invalid spherical geometry and ring that intersects itself

#check crs of each, they look the same

st_crs(flood_1893)
st_crs(flood_1974)
st_crs(flood_2011)

#different bounding boxes when plotted though, especially 2011 which will need to be cropped to be similar to the other years.
ggplot()+
  geom_sf(data=flood_1893, fill="lightblue", size=0.01)
ggplot()+
  geom_sf(data = flood_1974, fill="lightblue", size=0.01)
ggplot()+
  geom_sf(data = flood_2011, fill="lightblue", size = 0.01)

# get the union of 1974 and 2011 first
flood_1893_1974 <- st_union(flood_1893, flood_1974)
ggplot()+
  geom_sf(data = flood_1893_1974, fill="lightblue", size = 0.01)


#crop the 2011 floods to the extent of the union
flood_2011b <- st_crop(x = flood_2011, y = st_bbox(flood_1893_1974))

st_bbox(flood_2011)
st_bbox(flood_2011b)

ggplot()+
  geom_sf(data = flood_2011b, fill="lightblue", size = 0.01)


#JOINING and EXPORTING THE 2011 file is problematic. 

# flood_1893_1974_2011b <-  st_cast(flood_1893_1974_2011, "MULTIPOLYGON")
# 
# ggplot()+
#   geom_sf(data = flood_1893_1974_2011, fill="lightblue", size=0.01)
# 
# 
# 
# st_write(obj = flood_1893_1974_2011, dsn = here("data/spatial/joined_1893_1974_2011_floods/joined_1893_1974_2011.shp"), layer_options = "ENCODING=UTF-8", overwrite = TRUE)
# 
# #this doesn't work
# retry <- st_read(here("data/spatial/joined_1893_1974_2011_floods/joined_1893_1974_2011.shp"))
# 
# ggplot()+
#   geom_sf(data = retry, fill="lightblue", size=0.01)

```


#Brisbane LGA 

The bris lga shapefile seems to include moreton and some surrounding islands so without cropping might not be all that useful. Also its the same coverage as the flood extent awareness map
```{r}

lgas <- ozmaps::ozmap_data(data = "abs_lga")

bris_lga <- lgas %>% filter(NAME == unique(lgas$NAME)[grep("Brisbane", unique(lgas$NAME))]) %>% st_transform(crs = st_crs(flood_extents_shp))


```


Get major water ways data
```{r}

watercourse <- st_read(here("data/spatial/major_waterways/Major_watercourse_lines.shp"))

bris_watercourse <- watercourse %>% filter(NAME == "Brisbane River") 

ggplot()+
  geom_sf(data= bris_watercourse)


```

Get the SA2 data from (ABS - confirm with connie)
```{r}
SA2_aus <- st_read(here("data/spatial/sa2_2016_aust_shape/SA2_2016_AUST.shp"))

SA2_bris <- SA2_aus %>% 
  filter(STE_NAME16 == "Queensland" & 
           GCC_NAME16 == "Greater Brisbane" &
           SA4_NAME16 %in%  c("Brisbane - East","Brisbane - North", "Brisbane - South", "Brisbane - West", "Brisbane Inner City") & 
           (! SA2_NAME16 %in% c("Redland Islands"))) %>% 
  st_transform(crs = st_crs(flood_extents_shp))

ggplot()+
  geom_sf(data= SA2_bris)


#get the intersection of the flood awareness maps with the S2 data for greater brisbane - this is good for display purposes but actually needs filtering by SA2 included within Bris LGA
#SA2_bris_lga <- st_intersection(SA2_bris, st_bbox(flood_extents_shp))


ggplot()+
  geom_sf(data = SA2_bris)+
  geom_sf(data = flood_extents_shp, size=0.01, fill="lightblue", alpha = 0.8)
```


Join SA2 to socoeconomic and demographic data

```{r}
#so maybe find those SA2 regions in the housing data?

read_csv(here("data/raw_data/Unit_House_STRD_Household_HHCD_SA2_Brisbane.csv")) |> 
  row_to_names(row_number = 1) |> 
  select(1:3) |> 
  filter(SA2!= "Total") |> 
  filter(!is.na(SA2))


  


```

#Bring in the facilities and transport layers


Emergency services
```{r}

ems <- st_read(here("data/spatial/QSC_QLD emergency service locations/Emergency_services_facilities.shp")) %>% st_transform(crs = st_crs(flood_extents_shp))
ems_crop <- st_crop(x = ems, y = st_bbox(flood_extents_shp)) %>% filter(ATTRIBUTES %in% c("Queensland Ambulance Service", "Queensland Fire and Emergency Services", "Queensland Police Service"))
ems_intersect <- st_intersection(ems_crop, SA2_bris)



ggplot()+
   geom_sf(data = flood_extents_shp, size=0.01, fill="lightblue", alpha = 1)+
  geom_sf(data = SA2_bris, alpha=0, size =0.5)+
  geom_sf(data = ems_crop, aes(colour = ATTRIBUTES), size= 0.2)+
  theme_bw()


ggsave(filename = here("explore/cottrell_explore/ems_inundation_SA2.jpg"), device = "jpg", dpi = 300, width = 20, height = 10, units = "cm")

```

Hospital and health services

```{r}
health_services <- st_read(here("data/spatial/QSC_QLD Hospital and health services boundaries/Hospital_and_Health_Service_boundaries.shp")) %>% st_transform(crs = st_crs(flood_extents_shp))
health_services_crop <- st_crop(x = health_services, y = st_bbox(flood_extents_shp))

#these are just polygons of health service areas
ggplot()+
  geom_sf(data = health_services_crop)



```


Petrol stations
```{r}

petrol <- st_read(here("data/spatial/Petrol_Stations_Australia/PetrolStations.gdb")) %>% st_transform(crs = st_crs(flood_extents_shp))
petrol_crop <- st_crop(x = petrol, y = st_bbox(SA2_bris))
petrol_intersect <- st_intersection(x = petrol_crop, y = SA2_bris)



ggplot()+
   geom_sf(data = flood_extents_shp, size=0.01, fill="lightblue", alpha = 1)+
  geom_sf(data = SA2_bris, alpha=0, size =0.2, colour= "grey50")+
  geom_sf(data = ems_intersect, aes(colour = ATTRIBUTES), size= 0.2)+
  geom_sf(data = petrol_intersect, aes(fill = OPERATIONALSTATUS), size = 0.3, shape = 17)+
  theme_bw()+
  labs(colour = "EMS", fill="Petrol stations")


ggsave(filename = here("explore/cottrell_explore/ems_petrol_inundation_SA2.jpg"), device = "jpg", dpi = 300, width = 20, height = 10, units = "cm")


```

Get public transport layers

```{r}

bus_stops <- read_sf(here("data/spatial/Bus_Stop_locations/Bus_Stop_locations.shp"))

ferry_terminals <- read_sf(here("data/spatial/Ferry_Terminal_locations/Ferry_Terminal_locations.shp"))

ggplot()+
  geom_sf(data = flood_extents_shp, fill="lightblue", colour = "grey90", size = 0.01)+
  geom_sf(data = SA2_bris, alpha=0, size =0.2, colour= "grey50")+
  geom_sf(data = bus_stops, size =0.01)+
  geom_sf(data = ferry_terminals, size =0.01, colour ="red")
  


```




