---
title: "01_calculate_inundation_area_sa1"
author: "Rich Cottrell & converted to SA1 by Tace Stewart"
date: "21/09/2023"
output: pdf_document
---


```{r}
library(tidyverse)
library(here)
library(sf)
library(rmapshaper)

```


# Flood extent awareness maps

We need to reduce the buffer around the Flood Awareness Map edges to zero otherwise it intersects itself. To do that, first the shapefile needs some simplifying to run the reduced buffer function.
```{r}

#Import shapefile
flood_extents_shp <- st_read(here("data/spatial/Flood__Awareness__Extents/Flood___Awareness___Extents.shp"))

#Simplify the flood awareness shapefile
flood_extents_shp_simple <- flood_extents_shp |> ms_simplify(keep=0.05)

#reduce buffer around lines to zero
flood_extent_simple_0_buffer <- flood_extents_shp_simple |> st_buffer(dist = 0)

flood_extent_simple_0_buffer |> slice(c(3449, 3509))

#write_sf(flood_extent_simple_0_buffer, here("data/spatial/Flood__Awareness__Extents/Flood__Awareness__Extents__Simplified.shp"))

#check it doesn't oversimplify to the point of being unhelpful - looks good
ggplot()+
  geom_sf(data = flood_extent_simple_0_buffer, fill="lightblue", colour = "grey90", linewidth = NA)+
  theme_bw()

#the two polygons that won't write seem to make no difference to the plot?
ggplot()+
  geom_sf(data = flood_extent_simple_0_buffer|> slice(-c(3449, 3509)), fill="lightblue", colour = "grey90", linewidth = NA)+
  theme_bw()


```

Individual flood events

```{r}

#import shapefiles
flood_1974 <- st_read(here("data/spatial/flood_awareness_1974/Flood___Awareness___Historic___Brisbane_River_Floods___Jan_1974.shp"))


flood_2011 <- st_read(here("data/spatial/flood_awareness_2011/Flood___Awareness___Historic___Brisbane_River_Floods___Jan_2011.shp"))|> ms_simplify(keep = 0.05) |> st_buffer(dist = 0)


flood_2022 <- st_read(here("data/spatial/flood_awareness_2022/Flood___Awareness___Historic___Brisbane_River_and_Creek_Floods___Feb_2022.shp")) |> ms_simplify(keep = 0.05) |> st_buffer(dist = 0)


#plot extents
ggplot()+
  geom_sf(data = flood_1974, size=0.1, fill="aliceblue")


ggplot()+
  geom_sf(data = flood_2011, size=0.1, fill="aliceblue")

ggplot()+
  geom_sf(data = flood_2022, size=0.1, fill="aliceblue")



#create bouding box for standard extents?
flood_2011_crop <- st_crop(x = flood_2011, y = st_bbox(flood_1974))
flood_2022_crop <- st_crop(x = flood_2022, y = st_bbox(flood_1974))

#plot new extents - looks good

ggplot()+
  geom_sf(data = flood_1974, fill = "hotpink", alpha = 0.5)+
  geom_sf(data = flood_2011_crop, fill = "purple", alpha = 0.2)+
  geom_sf(data = flood_2022_crop, fill = "dodgerblue1", alpha = 0.2)

#write cropped layers
st_write(flood_1974, here("data/spatial/flood_1974_crop/flood_1974_crop.shp"))
st_write(flood_2011_crop, here("data/spatial/flood_2011_crop/flood_2011_crop.shp"))
st_write(flood_2022_crop, here("data/spatial/flood_2022_crop/flood_2022_crop.shp"))


flood_2022_crop |> filter(SHAPE_Area == 135318362.5)

ggplot()+
  geom_sf(data = flood_2022_crop |> filter(SHAPE_Area == 135318362.5))


```




# SA1 regions
```{r}

#import the 2021 sa1 regions 
    SA1_bris <- st_read(here("data/spatial/SA1_Bris/bris_sa1.shp")) |> st_transform(crs = st_crs(flood_extents_shp))
 

#have a quick look that the SA2s included are sensible
ggplot()+
  geom_sf(data= SA1_bris)

```


Split and overlay awareness map on SA1 regions 
```{r}

#split shapfile by SA1

SA1_shp_list <- 
  SA1_bris |> 
  group_by(SA1_CODE21) |> 
  group_split()


#test function
this_sa1_polygon <- SA1_shp_list[[2]]

#Create dataframe of inundation for each

sa1_flooded_area_df <- 
  
  map_df(.x = SA1_shp_list, .f = \(this_sa1_polygon){
  
  this_SA1_code <- this_sa1_polygon$SA1_CODE21 |> unique()
  
  message("Processing flooded area calculation for", this_SA1_code)
  
  this_SA1_area <- st_area(this_sa1_polygon) |> units::drop_units() |> as.numeric()
  
  this_flooded_area <- st_intersection(this_sa1_polygon, flood_extent_simple_0_buffer) |> st_area() |> units::drop_units() |> as.numeric() |> sum(na.rm = TRUE)
  
  this_prop_flooded <- (this_flooded_area/this_SA1_area)
  
  this_SA1_df <- tibble(sa1_code = this_SA1_code, sa1_area_km2 =  this_SA1_area/10^6, flooded_area_km2 = this_flooded_area/10^6, prop_flooded = this_prop_flooded)

})

write_csv(x = sa1_flooded_area_df, file = here("data/data_products/sa1_inundation.csv"))


import_flood_2022 <- st_read(here("data/spatial/flood_2022_crop/flood_2022_crop.shp"))


ggplot()+
  geom_sf(data = import_flood_2022, fill = "hotpink", size=0.005)

```



