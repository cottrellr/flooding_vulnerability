---
title: "01_calculate_inundation_area"
author: "Rich Cottrell"
date: "29/09/2022"
output: pdf_document
---


```{r}
library(tidyverse)
library(here)
library(sf)
library(rmapshaper)

```


# Flood extent awareness maps

We need to reduce the buffer around the Flood Awareness Map edges to zero otherwise it intersects itself. To do that, first the shapefile needs some simplifying to run the reduced buffer function.
```{r}

#Import shapefile
flood_extents_shp <- st_read(here("data/spatial/Flood__Awareness__Extents/Flood___Awareness___Extents.shp"))

#Simplify the flood awareness shapefile
flood_extents_shp_simple <- flood_extents_shp |> ms_simplify(keep=0.05)

#reduce buffer around lines to zero
flood_extent_simple_0_buffer <- flood_extents_shp_simple |> st_buffer(dist = 0)

#check it doesn't oversimplify to the point of being unhelful - looks good
ggplot()+
  geom_sf(data = flood_extent_simple_0_buffer, fill="lightblue", colour = "grey90", linewidth = NA)+
  theme_bw()




```
# SA2 regions
```{r}

#import the SA2 regions - using the 2021 update
SA2_aus <- st_read(here("data/spatial/sa2_2016_aust_shape/SA2_2016_AUST.shp"))

SA2_bris <- SA2_aus %>% 
  filter(STE_NAME16 == "Queensland" & 
           GCC_NAME16 == "Greater Brisbane" &
           SA4_NAME16 %in%  c("Brisbane - East","Brisbane - North", "Brisbane - South", "Brisbane - West", "Brisbane Inner City") & 
           (! SA2_NAME16 %in% c("Redland Islands"))) %>% 
  st_transform(crs = st_crs(flood_extents_shp))

#have a quick look that the SA2s included are sensible
ggplot()+
  geom_sf(data= SA2_bris)

```


Split and overlay awareness map on SA2 regions 
```{r}

#split shapfile by SA2
SA2_shp_list <- 
  SA2_bris |> 
  group_by(SA2_NAME16) |> 
  group_split()


#test function
this_sa2_polygon <- SA2_shp_list[[2]]

#Create dataframe of inundation for each SA2

sa2_flooded_area_df <- 
  
  map_df(.x = SA2_shp_list, .f = \(this_sa2_polygon){
  
  this_SA2_code <- this_sa2_polygon$SA2_MAIN16 |> unique()
  
  this_SA2_name <- this_sa2_polygon$SA2_NAME16 |> unique()
  
  message("Processing flooded area calculation for ", this_SA2_name, ", ", this_SA2_code)
  
  this_SA2_area <- st_area(this_sa2_polygon) |> units::drop_units() |> as.numeric()
  
  this_flooded_area <- st_intersection(this_sa2_polygon, flood_extent_simple_0_buffer) |> st_area() |> units::drop_units() |> as.numeric() |> sum(na.rm = TRUE)
  
  this_prop_flooded <- (this_flooded_area/this_SA2_area)
  
  this_SA2_df <- tibble(sa2_code = this_SA2_code, sa2_name = this_SA2_name, sa2_area_km2 =  this_SA2_area/10^6, flooded_area_km2 = this_flooded_area/10^6, prop_flooded = this_prop_flooded)

})

write_csv(x = sa2_flooded_area_df, file = here("data/data_products/sa2_inundation.csv"))
```



