---
title: "Join sensitivity data to SA2"
author: "Catherine Kim"
date: "27/06/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries}
library(sf)
library(tidyverse)
library(janitor)
library(here)
library(rmapshaper)
library(ozmaps)
library(skimr)
```

## Sensitivity - join these to SA2 polygons Catherine

Ave elevation for SA2s - Rich aggregate to SA2 level
Demographic data
Power
Dwelling type, proportion of total dwellings

Read in files and plot

```{r echo=FALSE}
bris_sa2 <- st_read(here('data/spatial/SA2_2021_BRIS_SHAPE/SA2_2021_BRIS.shp')) %>% 
  filter(GCC_NAME21 == "Greater Brisbane") %>% 
  select(SA2_NAME21, SA2_CODE21, geometry)

ggplot() +
  geom_sf(data = bris_sa2) +
  theme_bw() +
  theme(legend.position = "none")
```

## Read in sensitivity data

### Variable type

```{r }
library(zoo)
# DWELLINGS CODE
dwell <- read_csv('data/raw_data/2021_census/Dwelling_type_SA2_code_Brisbane_2021_R.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
glimpse(dwell)
names(dwell)
dwell

# EDUCATION CODE
# edu <- read_csv('data/raw_data/2021_census/HEAP_Edu_15yr+SA2_code_Brisbane_2021_R.csv') %>%
#   na.locf(fromLast=FALSE) %>%
#   clean_names()

# DISABILITY CODE
# disabl <- read_csv('data/raw_data/2021_census/Disability_ASSNP_SA2_code_Brisbane_2021_R.csv') %>%
#   na.locf(fromLast=FALSE) %>%
#   clean_names()
# pop <- read_csv('data/raw_data/2021_census/Population_SA2_code_Brisbane_2021_new_R.csv') %>%
#   na.locf(fromLast=FALSE) %>%
#   clean_names()
# prop_disabl <- merge(disabl, pop, by.x = "sa2_en", by.y = "sa2_en", all = TRUE)

# VULNERABLE AGE CODE
# vulnrbl <- read_csv('data/raw_data/2021_census/Age5P_SA2_Code_Brisbane_2021_R.csv') %>%
#   na.locf(fromLast=FALSE) %>%
#   clean_names()

# UNEMPLOYMENT CODE
# unemp <- read_csv('data/raw_data/2021_census/Unemployment_SA2_code_Brisbane_2021_R.csv') %>%
#   na.locf(fromLast=FALSE) %>%
#   clean_names()

# ESL CODE
# esl <- read_csv('data/raw_data/2021_census/English_proficiency_and_other_language_SA2_code_Brisbane_2021_R.csv') %>%
#   na.locf(fromLast=FALSE) %>%
#   clean_names()

# INDIGENOUS CODE
# indigenous <- read_csv('data/raw_data/2021_census/Indigenous_SA2_code_Brisbane_2021_R.csv') %>%
#   na.locf(fromLast=FALSE) %>%
#   clean_names()

# LONGTERM HEALTH CONDITIONS CODE
# health_cond <- read_csv('data/raw_data/2021_census/Long-term_Health_Conditions_SA2_code_Brisbane_2021_R.csv') %>%
#   na.locf(fromLast=FALSE) %>%
#   clean_names()

# POPULATION CODE
# pop2021 <- read_csv('data/raw_data/2021_census/Population_SA2_code_Brisbane_2021_new_R.csv') %>%
#   na.locf(fromLast=FALSE) %>%
#   clean_names()

# FAMILY DWELLING CODE
familydwell <- read_csv('data/raw_data/2021_census/Family_Household_Compostition_SA2_code_Brisbane_2021_R.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()

```

```{r}
# DWELLINGS CODE
prop_house <- dwell %>%
  select(sa2_en,
         separate_house,
         semi_detached_row_or_terrace_house_townhouse_etc_with_one_storey,
         semi_detached_row_or_terrace_house_townhouse_etc_with_two_or_more_storeys,
         flat_or_apartment_in_a_one_or_two_storey_block,
         flat_or_apartment_attached_to_a_house,
         caravan,
         cabin_houseboat,
         improvised_home_tent_sleepers_out,
         house_or_flat_attached_to_a_shop_office_etc,
         total)

prop_house <- mutate(prop_house,
                     prop_house = (separate_house +
                                                                      semi_detached_row_or_terrace_house_townhouse_etc_with_one_storey +
                                     semi_detached_row_or_terrace_house_townhouse_etc_with_two_or_more_storeys +
                                     flat_or_apartment_in_a_one_or_two_storey_block +
                                     flat_or_apartment_attached_to_a_house +
                                     caravan +
                                     cabin_houseboat +
                                     improvised_home_tent_sleepers_out +
                                     house_or_flat_attached_to_a_shop_office_etc) / total)

for (row in 1:nrow(prop_house)) {
  prop_house$prop_house[row] <- min(prop_house$prop_house[row], 1)
}

skim(prop_house)

# returns tibble
prop_house %>%
  full_join(bris_sa2, by = c('sa2_en' = 'SA2_NAME21'))

write.csv(prop_house, 'data/processed_data/dwell_house2021.csv', row.names = FALSE)

# EDUCATION CODE
# prop_uned <- edu %>% 
#   select(sa2_en,
#          secondary_education_years_9_and_below,
#          total) 
# 
# prop_uned <- mutate(prop_uned,
#                    prop_uned = secondary_education_years_9_and_below / total)
# 
# for (row in 1:nrow(prop_uned)) {
#   prop_uned$prop_uned[row] <- min(prop_uned$prop_uned[row], 1)
# }
# 
# skim(prop_uned)
# 
# # returns tibble
# prop_uned %>% 
#   full_join(bris_sa2, by = c('sa2_en' = 'SA2_NAME21'))
# 
# write.csv(prop_uned, 'data/processed_data/edu2021.csv', row.names = FALSE)

# DISABILITY CODE
# prop_disabl <- prop_disabl %>%
#   select(sa2_en,
#          has_need_for_assistance_with_core_activities,
#          total.y)
# 
# prop_disabl <- mutate(prop_disabl,
#                    prop_disabl = has_need_for_assistance_with_core_activities / total.y)
# 
# for (row in 1:nrow(prop_disabl)) {
#   prop_disabl$prop_disabl[row] <- min(prop_disabl$prop_disabl[row], 1)
# }
# 
# skim(prop_disabl)
# 
# # returns tibble
# prop_disabl %>%
#   full_join(bris_sa2, by = c('sa2_en' = 'SA2_NAME21'))
# 
# write.csv(prop_disabl, 'data/processed_data/disabl2021.csv', row.names = FALSE)

# VULNERABLE AGE CODE 
# - "0-4 years" for vulnerable young
# - "90-94 years", "95-99 years", "100 years and over" for vulnerable old
# prop_vulnrbl <- vulnrbl %>%
#   select(sa2_en,
#          x0_4_years,
#          total)
# 
# prop_vulnrbl <- mutate(prop_vulnrbl,
#                    prop_young = x0_4_years / total)
# 
# for (row in 1:nrow(prop_vulnrbl)) {
#   prop_vulnrbl$prop_young[row] <- min(prop_vulnrbl$prop_young[row], 1)
# }
# 
# skim(prop_vulnrbl)
# 
# # returns tibble
# prop_vulnrbl %>%
#   full_join(bris_sa2, by = c('sa2_en' = 'SA2_NAME21'))
# 
# write.csv(prop_vulnrbl, 'data/processed_data/vulnerable_young2021.csv', row.names = FALSE)

# UNEMPLOYMENT CODE
# prop_unemp <- unemp %>%
#   select(sa2_en,
#          unemployed,
#          total)
# 
# prop_unemp <- mutate(prop_unemp,
#                    prop_unemp = unemployed / total)
# 
# for (row in 1:nrow(prop_unemp)) {
#   prop_unemp$prop_unemp[row] <- min(prop_unemp$prop_unemp[row], 1)
# }
# 
# skim(prop_unemp)
# 
# # returns tibble
# prop_unemp %>%
#   full_join(bris_sa2, by = c('sa2_en' = 'SA2_NAME21'))
# 
# write.csv(prop_unemp, 'data/processed_data/unemployed2021.csv', row.names = FALSE)

# ESL CODE
# # Select relevant columns only
# prop_esl <- esl %>%
#   select(sa2_en,
#          uses_other_language_and_speaks_english_not_well,
#          uses_other_language_and_speaks_english_not_at_all,
#          total)
# 
# # Calculate proportion
# prop_esl <- mutate(prop_esl,
#                    prop_esl = (uses_other_language_and_speaks_english_not_well +
#                                    uses_other_language_and_speaks_english_not_at_all) /
#                      total)
# 
# # Deal with percentages over 100% caused by data randomness
# for (row in 1:nrow(prop_esl)) {
#   prop_esl$prop_esl[row] <- min(prop_esl$prop_esl[row], 1)
# }
# 
# # Get summary
# skim(prop_esl)
# 
# # returns tibble
# prop_esl %>%
#   full_join(bris_sa2, by = c('sa2_en' = 'SA2_NAME21'))
# 
# # Write to csv
# write.csv(prop_esl, 'data/processed_data/esl2021.csv', row.names = FALSE)

# INDIGENOUS CODE
# # Select relevant columns only
# prop_indigenous <- indigenous %>%
#   select(sa2_en,
#          aboriginal,
#          torres_strait_islander,
#          both_aboriginal_and_torres_strait_islander,
#          total)
# 
# # Calculate proportion
# prop_indigenous <- mutate(prop_indigenous,
#                           prop_indigenous = (aboriginal +
#                                                torres_strait_islander +
#                                                both_aboriginal_and_torres_strait_islander) /
#                             total)
# 
# # Deal with percentages over 100% caused by data randomness
# for (row in 1:nrow(prop_indigenous)) {
#   prop_indigenous$prop_indigenous[row] <- min(prop_indigenous$prop_indigenous[row], 1)
# }
# 
# # Get summary
# skim(prop_indigenous)
# 
# colnames(prop_indigenous)[1] <- 'SA2_NAME21'
# a <- merge(prop_indigenous, bris_sa2, by = 'SA2_NAME21', all = TRUE)
# b <- a[, c("SA2_CODE21", "aboriginal", "torres_strait_islander", 
#            "both_aboriginal_and_torres_strait_islander", "total",
#            "prop_indigenous")]
# 
# # Write to csv
# write.csv(b, 'data/processed_data/indigenous2021.csv', row.names = FALSE)

# LONGTERM HEALTH CONDITIONS CODE
# Select relevant columns only
# prop_health_cond <- health_cond %>%
#   select(sa2_en,
#          one_condition,
#          two_conditions,
#          three_or_more_conditions,
#          total)
# 
# # Calculate proportion
# prop_health_cond <- mutate(prop_health_cond,
#                            prop_health_cond = (one_condition +
#                                                  two_conditions +
#                                                  three_or_more_conditions) /
#                              total)
# 
# # Deal with percentages over 100% caused by data randomness
# for (row in 1:nrow(prop_health_cond)) {
#   prop_health_cond$prop_health_cond[row] <- min(prop_health_cond$prop_health_cond[row], 1)
# }
# 
# # Get summary
# skim(prop_health_cond)
# 
# # returns tibble
# prop_health_cond %>%
#   full_join(bris_sa2, by = c('sa2_en' = 'SA2_NAME21'))
# 
# colnames(prop_health_cond)[1] <- 'SA2_NAME21'
# a <- merge(prop_health_cond, bris_sa2, by = 'SA2_NAME21', all = TRUE)
# b <- a[, c("SA2_CODE21", "one_condition", "two_conditions",
#            "three_or_more_conditions", "total",
#            "prop_health_cond")]
# 
# # Write to csv
# write.csv(b, 'data/processed_data/long-term_health_cond2021.csv', row.names = FALSE)

# POPULATION CODE
# # Select relevant columns only
# pop_2021 <- pop2021 %>%
#   select(sa2_en,
#          total)
# 
# # returns tibble
# pop_2021 %>%
#   full_join(bris_sa2, by = c('sa2_en' = 'SA2_CODE21'))
# 
# # Write to csv
# write.csv(pop_2021, 'data/processed_data/Population2021.csv', row.names = FALSE)

# FAMILY DWELLING CODE
# Select relevant columns only
prop_familydwell <- familydwell %>%
  select(sa2_en,
         one_family_household_one_parent_family,
         one_family_household_other_family,
         two_family_household_couple_family_with_no_children,
         two_family_household_couple_family_with_children,
         two_family_household_one_parent_family,
         two_family_household_other_family,
         three_or_more_family_household_couple_family_with_no_children,
         three_or_more_family_household_couple_family_with_children,
         three_or_more_family_household_one_parent_family,
         three_or_more_family_household_other_family,
         total)

# Calculate proportion
prop_familydwell <- mutate(prop_familydwell,
                           prop_familydwell = (one_family_household_one_parent_family +
                                                 one_family_household_other_family +
                                                 two_family_household_couple_family_with_no_children +
                                                 two_family_household_couple_family_with_children +
                                                 two_family_household_one_parent_family +
                                                 two_family_household_other_family +
                                                 three_or_more_family_household_couple_family_with_no_children +
                                                 three_or_more_family_household_couple_family_with_children +
                                                 three_or_more_family_household_one_parent_family +
                                                 three_or_more_family_household_other_family) /
                             total)

# Deal with percentages over 100% caused by data randomness
for (row in 1:nrow(prop_familydwell)) {
  prop_familydwell$prop_familydwell[row] <- min(prop_familydwell$prop_familydwell[row], 1)
}

# Get summary
skim(prop_familydwell)

# returns tibble
prop_familydwell %>%
  full_join(bris_sa2, by = c('sa2_en' = 'SA2_CODE21'))

# Write to csv
write.csv(prop_familydwell, 'data/processed_data/familydwelling2021.csv', row.names = FALSE)

```

```{r }
# DWELLINGS CODE
# prop_house_sf <- merge(bris_sa2, prop_house, by.x = "SA2_CODE21", by.y = "sa2_en", all = TRUE)


# EDUCATION CODE
# prop_uned_sf <- merge(bris_sa2, prop_uned, by.x = "SA2_CODE21", by.y = "sa2_en", all = TRUE)

# DISABILITY CODE
# prop_disabl_sf <- merge(bris_sa2, prop_disabl, by.x = "SA2_CODE21", by.y = "sa2_en", all = TRUE)

# VULNERABLE CODE
# prop_vulnrbl_sf <- merge(bris_sa2, prop_vulnrbl, by.x = "SA2_CODE21", by.y = "sa2_en", all = TRUE)

# UNEMPLOYMENT CODE
# prop_unemp_sf <- merge(bris_sa2, prop_unemp, by.x = "SA2_CODE21", by.y = "sa2_en", all = TRUE)

# ESL CODE
# prop_esl_sf <- merge(bris_sa2, prop_esl, by.x = "SA2_CODE21", by.y = "sa2_en", all = TRUE)

# INDIGENOUS CODE
# prop_indigenous_sf <- merge(bris_sa2,
#                             prop_indigenous,
#                             by.x = "SA2_NAME21",
#                             by.y = "SA2_NAME21",
#                             all.x = TRUE,
#                             all = TRUE)

# LONGTERM HEALTH CONDITIONS CODE
# prop_health_cond_sf <- merge(bris_sa2,
#                              prop_health_cond,
#                              by.x = "SA2_NAME21",
#                              by.y = "SA2_NAME21",
#                              all.x = TRUE,
#                              all = TRUE)

# POPULATION CODE
# pop_2021_sf <- merge(bris_sa2,
#                      pop_2021,
#                      by.x = "SA2_CODE21",
#                      by.y = "sa2_en",
#                      all = TRUE)

# FAMILY DWELLING CODE
prop_familydwell_sf <- merge(bris_sa2,
                             prop_familydwell,
                             by.x = "SA2_CODE21",
                             by.y = "sa2_en",
                             all = TRUE)

```

## Plot w proportion of variable

```{r}
# DWELLINGS CODE
# ggplot() +
#   geom_sf(data = prop_house_sf, aes(fill = prop_house)) +
#   theme_bw() 

# EDUCATION CODE
# ggplot() +
#   geom_sf(data = prop_uned_sf, aes(fill = prop_uned)) +
#   theme_bw() 

# DISABILITY CODE
# ggplot() +
#   geom_sf(data = prop_disabl_sf, aes(fill = prop_disabl)) +
#   theme_bw() 

# VULNERABLE CODE
# ggplot() +
#   geom_sf(data = prop_vulnrbl_sf, aes(fill = prop_old)) +
#   theme_bw() 

# UNEMPLOYMENT CODE
# ggplot() +
#   geom_sf(data = prop_unemp_sf, aes(fill = prop_unemp)) +
#   theme_bw() 

# ESL CODE
# ggplot() +
#   geom_sf(data = prop_esl_sf, aes(fill = prop_esl)) +
#   theme_bw() 

# INDIGENOUS CODE
# ggplot() +
#   geom_sf(data = prop_indigenous_sf, aes(fill = prop_indigenous)) +
#   theme_bw()

# LONGTERM HEALTH CONDITIONS CODE
# ggplot() +
#   geom_sf(data = prop_health_cond_sf, aes(fill = prop_health_cond)) +
#   theme_bw()

# POPULATION CODE
# pop_2021_sf <- pop_2021_sf[pop_2021_sf$SA2_CODE21 != "Total",]
# ggplot() +
#   geom_sf(data = pop_2021_sf, aes(fill = total)) +
#   theme_bw()

# FAMILY DWELLING CODE
ggplot() +
  geom_sf(data = prop_familydwell_sf, aes(fill = prop_familydwell)) +
  theme_bw()

```

