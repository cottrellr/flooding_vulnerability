---
title: "Join sensitivity data to SA2"
author: "Catherine Kim"
date: "27/06/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries}
library(sf)
library(tidyverse)
library(janitor)
library(here)
library(rmapshaper)
library(ozmaps)
library(skimr)
```

## Sensitivity - join these to SA2 polygons Catherine

Ave elevation for SA2s - Rich aggregate to SA2 level
Demographic data
Power
Dwelling type, proportion of total dwellings

Read in files and plot

```{r echo=FALSE}
bris_sa2 <- st_read(here('data/spatial/SA2_2021_BRIS_SHAPE/SA2_2021_BRIS.shp')) %>% 
  filter(GCC_NAME21 == "Greater Brisbane") %>% 
  select(SA2_NAME21, SA2_CODE21, geometry)

ggplot() +
  geom_sf(data = bris_sa2) +
  theme_bw() +
  theme(legend.position = "none")
```

## Read in sensitivity data

### Variable type

```{r }
library(zoo)
# DWELLINGS CODE
# dwell <- read_csv('data/raw_data/2021_census/Dwelling_type_SA2_code_Brisbane_2021_R.csv') %>% 
#   na.locf(fromLast=FALSE) %>% 
#   clean_names()
# glimpse(dwell)
# names(dwell)
# dwell

# EDUCATION CODE
edu <- read_csv('data/raw_data/2021_census/HEAP_Edu_15yr+SA2_code_Brisbane_2021_R.csv') %>%
  na.locf(fromLast=FALSE) %>%
  clean_names()
```

```{r}
# DWELLINGS CODE
# prop_house <- dwell %>% 
#   select(sa2_en, 
#          separate_house,
#          semi_detached_row_or_terrace_house_townhouse_etc_with_one_storey,
#          semi_detached_row_or_terrace_house_townhouse_etc_with_two_or_more_storeys,
#          flat_or_apartment_in_a_one_or_two_storey_block,
#          flat_or_apartment_attached_to_a_house,
#          caravan,
#          cabin_houseboat,
#          improvised_home_tent_sleepers_out,
#          house_or_flat_attached_to_a_shop_office_etc,
#          total) 
# 
# prop_house <- mutate(prop_house, 
#                      prop_house = (separate_house +
#                                                                       semi_detached_row_or_terrace_house_townhouse_etc_with_one_storey +
#                                      semi_detached_row_or_terrace_house_townhouse_etc_with_two_or_more_storeys +
#                                      flat_or_apartment_in_a_one_or_two_storey_block +
#                                      flat_or_apartment_attached_to_a_house + 
#                                      caravan +
#                                      cabin_houseboat +
#                                      improvised_home_tent_sleepers_out +
#                                      house_or_flat_attached_to_a_shop_office_etc) / total) 
# 
# for (row in 1:nrow(prop_house)) {
#   prop_house$prop_house[row] <- min(prop_house$prop_house[row], 1)
# }
# 
# skim(prop_house)
# 
# # returns tibble
# prop_house %>% 
#   full_join(bris_sa2, by = c('sa2_en' = 'SA2_NAME21'))
# 
# write.csv(prop_house, 'data/processed_data/dwell_house2021.csv', row.names = FALSE)

# EDUCATION CODE
prop_uned <- edu %>% 
  select(sa2_en,
         secondary_education_years_9_and_below,
         total) 

prop_uned <- mutate(prop_uned,
                   prop_uned = secondary_education_years_9_and_below / total)

for (row in 1:nrow(prop_uned)) {
  prop_uned$prop_uned[row] <- min(prop_uned$prop_uned[row], 1)
}

skim(prop_uned)

# returns tibble
prop_uned %>% 
  full_join(bris_sa2, by = c('sa2_en' = 'SA2_NAME21'))

write.csv(prop_uned, 'data/processed_data/edu2021.csv', row.names = FALSE)
```

```{r }
# DWELLINGS CODE
# prop_house_sf <- merge(bris_sa2, prop_house, by.x = "SA2_CODE21", by.y = "sa2_en", all = TRUE)


# EDUCATION CODE
prop_uned_sf <- merge(bris_sa2, prop_uned, by.x = "SA2_CODE21", by.y = "sa2_en", all = TRUE)

#st_write(prop_house_sf, 'data/')

```

## Plot w proportion of variable

```{r}
# DWELLINGS CODE
# ggplot() +
#   geom_sf(data = prop_house_sf, aes(fill = prop_house)) +
#   theme_bw() 

# EDUCATION CODE
ggplot() +
  geom_sf(data = prop_uned_sf, aes(fill = prop_uned)) +
  theme_bw() 
```

